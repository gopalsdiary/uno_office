<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Duplicate Officers — Names</title>
  <style>
    body{font-family:kalpurush, Tahoma, Arial; background:#fff; margin:0; padding:16px}
    h1{font-size:20px;margin:0 0 12px}
    .controls{display:flex;gap:8px;margin-bottom:12px}
    button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#6366f1;color:#fff}
    .btn-secondary{background:#10b981;color:#fff}
    .btn-plain{background:#f3f4f6}
    #results{margin-top:16px}
    .group{border:1px solid #e5e7eb;padding:10px;border-radius:8px;margin-bottom:8px}
    .group-title{font-weight:700;color:#111827;margin-bottom:6px}
    .names{display:flex;flex-wrap:wrap;gap:6px}
    .name-pill{background:#f8fafc;padding:6px 10px;border-radius:999px;border:1px solid #e6eef6}
    .member-card{background:#fff;border:1px solid #e5e7eb;padding:12px;border-radius:10px;min-width:180px;max-width:280px;box-shadow:0 8px 20px rgba(2,6,23,0.08);transition:transform .15s ease, box-shadow .18s ease}
    .member-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.12)}
    #loading{display:none;margin-top:8px}
    #empty{color:#6b7280;margin-top:8px}
  </style>
</head>
<body>
  <h1>Duplicate officers (names only)</h1>

  <div class="controls">
    <button id="btn-refresh" class="btn-plain">Refresh Data</button>
    <button id="btn-export" class="btn-plain">Export CSV</button>
  </div>

  <div id="loading">⏳ Loading data...</div>
  <div id="empty" style="display:none">No duplicates found</div>

  <div id="results"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase singleton (same project as other pages)
    if (!window.supabaseClient) {
      const SUPABASE_URL = 'https://tschsyozvlneslqylqii.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzY2hzeW96dmxuZXNscXlscWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MzcyNjgsImV4cCI6MjA4MjMxMzI2OH0.7kfq7K-jbFmgnin2zkLJf7GIulGXvfQzBkzjs0iAO14';
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    const supabaseClient = window.supabaseClient || window.supabase; 

    const CHUNK = 1000;
    const MAX_FETCH = 50000;

    let allOfficers = [];

    async function fetchAllFromTable(table, sel, orderBy) {
      const rows = [];
      let from = 0;
      while (true) {
        const res = await supabaseClient.from(table).select(sel).order(orderBy, { ascending: true }).range(from, from + CHUNK - 1);
        if (res.error) throw res.error;
        const chunk = res.data || [];
        rows.push(...chunk);
        if (chunk.length < CHUNK) break;
        from += CHUNK;
        if (rows.length >= MAX_FETCH) break;
      }
      return rows;
    }

    async function loadAll() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('empty').style.display = 'none';
      document.getElementById('results').innerHTML = '';

      try {
        // Parallel fetch the three tables
        const [p, a, pol] = await Promise.all([
          fetchAllFromTable('presiding_list', 'presiding_iid, presiding_name, mobile_number, Nid_number', 'presiding_iid'),
          fetchAllFromTable('ass_presiding_list', 'ass_presiding_iid, ass_presiding_name, mobile_number, Nid_number', 'ass_presiding_iid'),
          fetchAllFromTable('polling_list', 'polling_iid, polling_name, mobile_number, Nid_number', 'polling_iid')
        ]);

        // Normalize into common shape
        allOfficers = [];
        p.forEach(r => allOfficers.push({ src: 'presiding', id: r.presiding_iid, name: (r.presiding_name || '').trim(), mobile: (r.mobile_number || '').trim(), nid: (r.Nid_number || '').trim() }));
        a.forEach(r => allOfficers.push({ src: 'ass_presiding', id: r.ass_presiding_iid, name: (r.ass_presiding_name || '').trim(), mobile: (r.mobile_number || '').trim(), nid: (r.Nid_number || '').trim() }));
        pol.forEach(r => allOfficers.push({ src: 'polling', id: r.polling_iid, name: (r.polling_name || '').trim(), mobile: (r.mobile_number || '').trim(), nid: (r.Nid_number || '').trim() }));

        document.getElementById('loading').style.display = 'none';
        // Data updated (no popup shown)
        // console.log('Data updated — total ' + allOfficers.length + ' records');

        // Automatically show duplicates for both NID and Mobile
        const foundNid = findDuplicatesBy('nid');
        const foundMobile = findDuplicatesBy('mobile');
        if (!foundNid && !foundMobile) {
          document.getElementById('empty').style.display = 'block';
        } else {
          document.getElementById('empty').style.display = 'none';
        }

      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        console.error(err);
        alert('Error loading data: ' + (err.message || err));
      }
    }

    // utility to normalize digits
    function normalizeDigits(str) {
      if (!str) return '';
      return ('' + str).replace(/\D/g, '').trim();
    }

    // Find duplicates by field ('nid' or 'mobile') and render only names
    function findDuplicatesBy(field) {
      if (!allOfficers || allOfficers.length === 0) {
        alert('Data is not loaded — please click "Refresh Data" first');
        return false;
      }

      const map = new Map();
      allOfficers.forEach(off => {
        const raw = off[field] || '';
        const norm = normalizeDigits(raw);
        if (!norm) return; // skip empty
        if (!map.has(norm)) map.set(norm, []);
        map.get(norm).push(off);
      });

      // collect names that belong to groups with more than 1 member
      const duplicateGroups = Array.from(map.entries()).filter(([k, arr]) => arr.length > 1);

      const resultsEl = document.getElementById('results');
      // do NOT clear results here so both NID and Mobile results can accumulate
      // caller will handle showing or hiding the empty message


      if (duplicateGroups.length === 0) {
        return false;
      }

      // Render groups as cards with members side-by-side
      duplicateGroups.forEach(([key, arr]) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group';
        // attach metadata for export and tracing
        groupDiv.dataset.key = key;
        groupDiv.dataset.field = field;

        const title = document.createElement('div');
        title.className = 'group-title';
        title.textContent = (field === 'nid' ? 'Duplicate by NID: ' : 'Duplicate by Mobile: ') + key + ' — ' + arr.length + ' matches';
        groupDiv.appendChild(title);

        const membersWrap = document.createElement('div');
        membersWrap.className = 'names';
        membersWrap.style.display = 'flex';
        membersWrap.style.gap = '8px';
        membersWrap.style.flexWrap = 'wrap';

        arr.forEach(member => {
          const card = document.createElement('div');
          card.className = 'member-card';
          // attach member metadata for easy export
          card.dataset.src = member.src || '';
          card.dataset.id = member.id || '';
          card.dataset.mobile = member.mobile || '';
          card.dataset.nid = member.nid || '';
          card.dataset.name = member.name || '';

          const nameEl = document.createElement('div');
          nameEl.style.fontWeight = '700';
          nameEl.textContent = member.name || '(no name)';
          const infoEl = document.createElement('div');
          infoEl.style.fontSize = '12px';
          infoEl.style.color = '#374151';
          infoEl.textContent = member.src + ' — ID: ' + (member.id || '-');
          const mobileEl = document.createElement('div');
          mobileEl.style.fontSize = '12px';
          mobileEl.style.color = '#6b7280';
          mobileEl.textContent = 'Mobile: ' + (member.mobile || '-');
          const nidEl = document.createElement('div');
          nidEl.style.fontSize = '12px';
          nidEl.style.color = '#6b7280';
          nidEl.textContent = 'NID: ' + (member.nid || '-');

          card.appendChild(nameEl);
          card.appendChild(infoEl);
          card.appendChild(mobileEl);
          card.appendChild(nidEl);

          membersWrap.appendChild(card);
        });

        groupDiv.appendChild(membersWrap);
        resultsEl.appendChild(groupDiv);
      });

      return true;
    }

    // Export current displayed groups and members to CSV
    function exportCSV() {
      const resultsEl = document.getElementById('results');
      if (!resultsEl.firstChild) {
        alert('No results to export');
        return;
      }

      const rows = [];
      // header
      rows.push(['group_field','group_key','name','source','id','mobile','nid']);

      Array.from(resultsEl.querySelectorAll('.group')).forEach(group => {
        const key = group.dataset.key || '';
        const field = group.dataset.field || '';
        Array.from(group.querySelectorAll('.member-card')).forEach(card => {
          rows.push([
            field,
            key,
            card.dataset.name || '',
            card.dataset.src || '',
            card.dataset.id || '',
            card.dataset.mobile || '',
            card.dataset.nid || ''
          ]);
        });
      });

      if (rows.length <= 1) { alert('No rows to export'); return; }

      const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'duplicate_groups.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('btn-refresh').addEventListener('click', () => { document.getElementById('results').innerHTML = ''; document.getElementById('empty').style.display = 'none'; loadAll(); });
    document.getElementById('btn-export').addEventListener('click', exportCSV);

    // initial load
    loadAll();
  </script>
</body>
</html>
