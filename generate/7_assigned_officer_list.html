<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶ï‡ßÉ‡¶§ ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: #f4f6f8; /* light neutral background for white-based design */
            color: #0f172a;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 98%;
            margin: 10px auto;
            background: #ffffff; /* card-style white */
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
            border: 1px solid #e6e9ee;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8fafc;
            color: #0f172a;
            padding: 18px;
            border-radius: 8px;
            text-align: center;
            box-shadow: none;
            border: 1px solid #e6eef6;
        }

        .stat-card.presiding {
            background: #eef9f2;
            color: #065f46;
            border-color: #d1fae5;
        }

        .stat-card.ass-presiding {
            background: #fff7ed;
            color: #92400e;
            border-color: #ffedd5;
        }

        .stat-card.polling {
            background: #fff1f2;
            color: #7f1d1d;
            border-color: #fee2e2;
        }

        .stat-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 25px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            font-size: 13px;
        }

        .data-table th {
            background: #f1f5f9; /* soft gray header */
            color: #0f172a;
            padding: 10px 8px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            white-space: nowrap;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            border-bottom: 1px solid #e6eef6;
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 200px;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Matched centre tick */
        .matched-tick {
            color: #1e90ff; /* blue */
            font-weight: bold;
            font-size: 18px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge.presiding {
            background: #d4edda;
            color: #155724;
        }

        .badge.ass-presiding {
            background: #fff3cd;
            color: #856404;
        }

        .badge.polling {
            background: #f8d7da;
            color: #721c24;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .stats-container,
            .filter-section,
            .loading,
            h1 {
                display: none !important;
            }

            .container {
                max-width: 100%;
                margin: 0;
                padding: 10px;
                box-shadow: none;
                border-radius: 0;
            }

            .data-table {
                page-break-inside: auto;
            }

            .data-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .data-table th {
                background: #667eea !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .badge {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Duty list (after generate)</h1>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>
        </div>

        <!-- Statistics Section -->
        <div class="stats-container">
            <div class="stat-card">
                <h3>‡¶Æ‡ßã‡¶ü ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</h3>
                <div class="number" id="totalCount">0</div>
            </div>
            <div class="stat-card presiding">
                <h3>‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</h3>
                <div class="number" id="presidingCount">0</div>
            </div>
            <div class="stat-card ass-presiding">
                <h3>‡¶∏‡¶π-‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</h3>
                <div class="number" id="assPresidingCount">0</div>
            </div>
            <div class="stat-card polling">
                <h3>‡¶™‡ßã‡¶≤‡¶ø‡¶Ç</h3>
                <div class="number" id="pollingCount">0</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <h3 style="margin-bottom: 15px; color: #667eea;">üîç ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filterOfficerType">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®</label>
                    <select id="filterOfficerType">
                        <option value="">‡¶∏‡¶ï‡¶≤</option>
                        <option value="presiding">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</option>
                        <option value="ass_presiding">‡¶∏‡¶π-‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</option>
                        <option value="polling">‡¶™‡ßã‡¶≤‡¶ø‡¶Ç</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterCentre">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ï‡ßã‡¶°/‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="filterCentre" placeholder="‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                </div>
                <div class="filter-group">
                    <label for="filterOfficer">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="filterOfficer" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    üîç ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="btn btn-warning" onclick="resetFilters()">
                    üîÑ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
                </button>
                <button class="btn btn-success" onclick="exportToCSV()">
                    üì• CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
                </button>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï</th>
                        <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                        <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®</th>
                        <th style="cursor: pointer;" onclick="sortByColumn('officer_iid')" title="‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">Off Sl <span id="sortIcon_officer_iid">‚áÖ</span></th>
                        <th style="cursor: pointer;" onclick="sortByColumn('centre_code')" title="‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ï‡ßã‡¶° <span id="sortIcon_centre_code">‚áÖ</span></th>
                        <th>‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                        <th>‡¶®‡¶ø‡¶ú ‡¶ú‡ßá‡¶≤‡¶æ</th>
                        <th>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</th>
                        <th>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</th>
                        <th>‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                        <th>‡¶Æ‡ßã‡¶ü ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞</th>
                        <th>‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø/ref</th>
                        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                        <th style="text-align: center">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 20px;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadData();
        });

        let allData = [];
        let filteredData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        // Sort by column
        function sortByColumn(column) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Sort the filtered data
            filteredData.sort((a, b) => {
                let valueA, valueB;

                if (column === 'officer_iid') {
                    valueA = parseInt(a.officer_iid) || 0;
                    valueB = parseInt(b.officer_iid) || 0;
                } else if (column === 'centre_code') {
                    valueA = parseInt(a.vote_centre_code) || 0;
                    valueB = parseInt(b.vote_centre_code) || 0;
                }

                if (currentSortDirection === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });

            // Update sort icons
            updateSortIcons();

            // Re-render table
            renderTable();
        }

        // Update sort icons
        function updateSortIcons() {
            // Reset all icons
            const icons = ['officer_iid', 'centre_code'];
            icons.forEach(col => {
                const icon = document.getElementById(`sortIcon_${col}`);
                if (icon) {
                    if (col === currentSortColumn) {
                        icon.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                    } else {
                        icon.textContent = '‚áÖ';
                    }
                }
            });
        }

        // Bengali number conversion
        function toBengaliNumber(num) {
            if (num === null || num === undefined || num === '') return '';
            const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
            return String(num).replace(/\d/g, digit => bengaliDigits[digit]);
        }

        // Format date strings to Bengali locale (returns '-' if empty)
        function formatToBengaliDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString('bn-BD');
        }

        // Show/hide loading
        function setLoading(isLoading) {
            const loading = document.getElementById('loading');
            loading.style.display = isLoading ? 'block' : 'none';
        }

        // Get officer type label in Bengali
        function getOfficerTypeLabel(type) {
            const labels = {
                'presiding': '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç',
                'ass_presiding': '‡¶∏‡¶π-‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç',
                'polling': '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç'
            };
            return labels[type] || type;
        }

        // Load all data
        async function loadData() {
            setLoading(true);
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>';

            try {
                // Fetch all centre assignments
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                const allAssignments = [];

                console.log('üìä Loading centre_assignments...');

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('centre_assignments')
                        .select('*')
                        .order('assignment_id', { ascending: true })
                        .range(from, from + CHUNK - 1);

                    if (error) throw error;

                    const chunk = data || [];
                    allAssignments.push(...chunk);
                    
                    console.log(`   Loaded chunk: ${chunk.length} rows, total: ${allAssignments.length}`);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allAssignments.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Total ${allAssignments.length} centre assignments loaded`);

                // Fetch vote_centre details for each assignment
                await fetchVoteCentreDetails(allAssignments);

                // Fetch officer details for each assignment
                await fetchOfficerDetailsForAssignments(allAssignments);

                // Fetch request_table to compare with assignments
                await fetchRequestTableData();

                // Set allData to assignments
                allData = allAssignments;

                // Update statistics
                updateStatistics();

                // Initial render
                filteredData = [...allData];
                renderTable();

            } catch (error) {
                console.error('Error loading data:', error);
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px; color: red;">‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</td></tr>';
            } finally {
                setLoading(false);
            }
        }

        // Fetch vote centre details for assignments
        async function fetchVoteCentreDetails(assignments) {
            console.log('üìä Fetching vote centre details...');
            
            // Get unique vote_centre_iid values
            const uniqueCentreIds = [...new Set(assignments.map(a => a.vote_centre_iid).filter(id => id))];
            
            console.log(`   Found ${uniqueCentreIds.length} unique centres`);

            // Fetch in batches
            const BATCH_SIZE = 500;
            const centreMap = new Map();

            for (let i = 0; i < uniqueCentreIds.length; i += BATCH_SIZE) {
                const batch = uniqueCentreIds.slice(i, i + BATCH_SIZE);
                
                const { data, error } = await window.supabaseClient
                    .from('vote_centre')
                    .select('vote_centre_iid, vote_centre_code, vote_centre_name, total_voter')
                    .in('vote_centre_iid', batch);

                if (!error && data) {
                    data.forEach(centre => {
                        centreMap.set(centre.vote_centre_iid, centre);
                    });
                }
            }

            // Attach centre details to assignments
            assignments.forEach(assignment => {
                const centre = centreMap.get(assignment.vote_centre_iid);
                if (centre) {
                    assignment.vote_centre_name = centre.vote_centre_name;
                    assignment.vote_centre_code = centre.vote_centre_code;
                    assignment.vote_centre_total_voter = centre.total_voter; // new
                }
            });

            console.log('‚úÖ Vote centre details fetched');
        }

        // Fetch officer details for assignments
        async function fetchOfficerDetailsForAssignments(assignments) {
            console.log('üìä Fetching officer details for assignments...');
            
            // Group by officer type
            const presidingIds = [];
            const assPresidingIds = [];
            const pollingIds = [];

            assignments.forEach(a => {
                if (a.officer_type === 'presiding') presidingIds.push(a.officer_iid);
                else if (a.officer_type === 'ass_presiding') assPresidingIds.push(a.officer_iid);
                else if (a.officer_type === 'polling') pollingIds.push(a.officer_iid);
            });

            // Create maps for each officer type
            const presidingMap = new Map();
            const assPresidingMap = new Map();
            const pollingMap = new Map();

            // Fetch presiding officers
            if (presidingIds.length > 0) {
                const BATCH_SIZE = 500;
                for (let i = 0; i < presidingIds.length; i += BATCH_SIZE) {
                    const batch = presidingIds.slice(i, i + BATCH_SIZE);
                    const { data, error } = await window.supabaseClient
                        .from('presiding_list')
                        .select('presiding_iid, presiding_name, own_discrict, address, previous_election, date_of_birth, comment')
                        .in('presiding_iid', batch);

                    if (!error && data) {
                        data.forEach(officer => {
                            presidingMap.set(officer.presiding_iid, officer);
                        });
                    }
                }
            }

            // Fetch ass_presiding officers
            if (assPresidingIds.length > 0) {
                const BATCH_SIZE = 500;
                for (let i = 0; i < assPresidingIds.length; i += BATCH_SIZE) {
                    const batch = assPresidingIds.slice(i, i + BATCH_SIZE);
                    const { data, error } = await window.supabaseClient
                        .from('ass_presiding_list')
                        .select('ass_presiding_iid, ass_presiding_name, own_discrict, address, previous_election, date_of_birth, comment')
                        .in('ass_presiding_iid', batch);

                    if (!error && data) {
                        data.forEach(officer => {
                            assPresidingMap.set(officer.ass_presiding_iid, officer);
                        });
                    }
                }
            }

            // Fetch polling officers
            if (pollingIds.length > 0) {
                const BATCH_SIZE = 500;
                for (let i = 0; i < pollingIds.length; i += BATCH_SIZE) {
                    const batch = pollingIds.slice(i, i + BATCH_SIZE);
                    const { data, error } = await window.supabaseClient
                        .from('polling_list')
                        .select('polling_iid, polling_name, own_discrict, address, previous_election, date_of_birth, comment')
                        .in('polling_iid', batch);

                    if (!error && data) {
                        data.forEach(officer => {
                            pollingMap.set(officer.polling_iid, officer);
                        });
                    }
                }
            }

            // Attach officer details to assignments
            assignments.forEach(assignment => {
                let officer = null;
                if (assignment.officer_type === 'presiding') {
                    officer = presidingMap.get(assignment.officer_iid);
                    if (officer) assignment.officer_name = officer.presiding_name;
                } else if (assignment.officer_type === 'ass_presiding') {
                    officer = assPresidingMap.get(assignment.officer_iid);
                    if (officer) assignment.officer_name = officer.ass_presiding_name;
                } else if (assignment.officer_type === 'polling') {
                    officer = pollingMap.get(assignment.officer_iid);
                    if (officer) assignment.officer_name = officer.polling_name;
                }

                if (officer) {
                    assignment.officer_details = {
                        own_discrict: officer.own_discrict,
                        address: officer.address,
                        previous_election: officer.previous_election,
                        date_of_birth: officer.date_of_birth,
                        comment: officer.comment
                    };
                }
            });

            console.log('‚úÖ Officer details fetched for assignments');
        }

        // Map to store requested centres from request_table
        const requestedCentreMap = {
            presiding: new Map(),
            ass_presiding: new Map(),
            polling: new Map()
        };

        // Fetch request_table data to compare with assignments
        async function fetchRequestTableData() {
            console.log('üìä Loading request_table...');
            const CHUNK = 1000;
            const MAX_FETCH = 50000;
            let from = 0;
            const allRequests = [];

            while (true) {
                const { data, error } = await window.supabaseClient
                    .from('request_table')
                    .select('officer_table_name, officer_table_iid, vote_centre_iid, vote_centre_code')
                    .range(from, from + CHUNK - 1);

                if (error) {
                    console.error('Error loading request_table:', error);
                    break;
                }

                const chunk = data || [];
                allRequests.push(...chunk);

                if (chunk.length < CHUNK) break;
                from += CHUNK;
                if (allRequests.length >= MAX_FETCH) break;
            }

            // Populate maps
            allRequests.forEach(req => {
                const info = { 
                    vote_centre_iid: req.vote_centre_iid, 
                    vote_centre_code: req.vote_centre_code 
                };
                if (req.officer_table_name === 'presiding') {
                    requestedCentreMap.presiding.set(String(req.officer_table_iid), info);
                } else if (req.officer_table_name === 'ass_presiding') {
                    requestedCentreMap.ass_presiding.set(String(req.officer_table_iid), info);
                } else if (req.officer_table_name === 'polling') {
                    requestedCentreMap.polling.set(String(req.officer_table_iid), info);
                }
            });

            console.log(`‚úÖ Loaded ${allRequests.length} request_table entries`);
        }

        // Update statistics
        function updateStatistics() {
            const total = allData.length;
            const presidingCount = allData.filter(row => row.officer_type === 'presiding').length;
            const assPresidingCount = allData.filter(row => row.officer_type === 'ass_presiding').length;
            const pollingCount = allData.filter(row => row.officer_type === 'polling').length;

            document.getElementById('totalCount').textContent = toBengaliNumber(total);
            document.getElementById('presidingCount').textContent = toBengaliNumber(presidingCount);
            document.getElementById('assPresidingCount').textContent = toBengaliNumber(assPresidingCount);
            document.getElementById('pollingCount').textContent = toBengaliNumber(pollingCount);
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');

            if (!filteredData || filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á</td></tr>';
                return;
            }

            let html = '';
            filteredData.forEach((row, index) => {
                const officerType = row.officer_type || '';
                const badgeClass = officerType === 'presiding' ? 'presiding' : 
                                   officerType === 'ass_presiding' ? 'ass-presiding' : 'polling';
                
                const details = row.officer_details || {};
                const ownDistrict = toBengaliNumber(details.own_discrict || '-');
                const address = toBengaliNumber(details.address || '-');
                const previousElection = toBengaliNumber(details.previous_election || '-');
                const comment = toBengaliNumber(details.comment || '-');
                const dateOfBirth = toBengaliNumber(formatToBengaliDate(details.date_of_birth || ''));
                const totalVoters = toBengaliNumber(row.vote_centre_total_voter || '-');
                const createdDate = toBengaliNumber(formatToBengaliDate(row.created_at || ''));
                
                // Check if assigned centre matches requested centre
                let statusSymbol = ''; // ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ by default (request ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá)
                try {
                    const requestedMap = requestedCentreMap[officerType] || new Map();
                    const requested = requestedMap.get(String(row.officer_iid));
                    
                    if (requested) {
                        // request_table ‡¶è ‡¶Ü‡¶õ‡ßá, ‡¶è‡¶ñ‡¶® check ‡¶ï‡¶∞‡¶ø match ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                        let matched = false;
                        if (requested.vote_centre_iid && row.vote_centre_iid && 
                            String(requested.vote_centre_iid) === String(row.vote_centre_iid)) {
                            matched = true;
                        } else if (requested.vote_centre_code && row.vote_centre_code && 
                                   String(requested.vote_centre_code) === String(row.vote_centre_code)) {
                            matched = true;
                        }
                        
                        // Set symbol based on match
                        statusSymbol = matched ? '‚úî' : '‚úó';
                    }
                    // else: requested ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá statusSymbol ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                } catch (e) {
                    console.error('Error comparing centres:', e);
                }
                
                html += `
                    <tr>
                        <td>${toBengaliNumber(index + 1)}</td>
                        <td>${toBengaliNumber(row.officer_name || '-')}</td>
                        <td><span class="badge ${badgeClass}">${getOfficerTypeLabel(officerType)}</span></td>
                        <td>${toBengaliNumber(row.officer_iid || '')}</td>
                        <td>${toBengaliNumber(row.vote_centre_code || '-')}</td>
                        <td>${toBengaliNumber(row.vote_centre_name || '-')}</td>
                        <td>${ownDistrict}</td>
                        <td>${address}</td>
                        <td>${previousElection}</td>
                        <td>${dateOfBirth}</td>
                        <td>${totalVoters}</td>
                        <td>${comment}</td>
                        <td>${createdDate}</td>
                        <td style="text-align:center"><span class="matched-tick">${statusSymbol}</span></td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Apply filters
        function applyFilters() {
            const officerType = document.getElementById('filterOfficerType').value;
            const centreFilter = document.getElementById('filterCentre').value.toLowerCase().trim();
            const officerFilter = document.getElementById('filterOfficer').value.toLowerCase().trim();

            filteredData = allData.filter(row => {
                // Filter by officer type
                if (officerType && row.officer_type !== officerType) {
                    return false;
                }

                // Filter by centre
                if (centreFilter) {
                    const centreCode = (row.vote_centre_code || '').toString().toLowerCase();
                    const centreName = (row.vote_centre_name || '').toLowerCase();
                    if (!centreCode.includes(centreFilter) && !centreName.includes(centreFilter)) {
                        return false;
                    }
                }

                // Filter by officer name
                if (officerFilter) {
                    const officerName = (row.officer_name || '').toLowerCase();
                    if (!officerName.includes(officerFilter)) {
                        return false;
                    }
                }

                return true;
            });

            renderTable();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterOfficerType').value = '';
            document.getElementById('filterCentre').value = '';
            document.getElementById('filterOfficer').value = '';
            filteredData = [...allData];
            renderTable();
        }

        // Export to CSV
        function exportToCSV() {
            if (!filteredData || filteredData.length === 0) {
                alert('‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á ‡¶Ø‡¶æ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§');
                return;
            }

            // Create CSV content
            let csv = '\uFEFF'; // UTF-8 BOM for proper Bengali display
            csv += '‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï,‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ,‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®,Officer IID,‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ï‡ßã‡¶°,‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ,‡¶®‡¶ø‡¶ú ‡¶ú‡ßá‡¶≤‡¶æ,‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ,‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®,‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶Æ‡ßã‡¶ü ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞,‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø,‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ,‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏\n';

            filteredData.forEach((row, index) => {
                const officerType = getOfficerTypeLabel(row.officer_type || '');
                const details = row.officer_details || {};
                const dob = toBengaliNumber(formatToBengaliDate(details.date_of_birth || ''));
                const createdDate = toBengaliNumber(formatToBengaliDate(row.created_at || ''));
                
                // Check if assigned centre matches requested centre for CSV
                let csvStatus = ''; // ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ by default (request ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá)
                try {
                    const requestedMap = requestedCentreMap[row.officer_type || ''] || new Map();
                    const requested = requestedMap.get(String(row.officer_iid));
                    
                    if (requested) {
                        // request_table ‡¶è ‡¶Ü‡¶õ‡ßá, ‡¶è‡¶ñ‡¶® check ‡¶ï‡¶∞‡¶ø match ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                        let matched = false;
                        if ((requested.vote_centre_iid && row.vote_centre_iid && 
                            String(requested.vote_centre_iid) === String(row.vote_centre_iid)) ||
                            (requested.vote_centre_code && row.vote_centre_code && 
                            String(requested.vote_centre_code) === String(row.vote_centre_code))) {
                            matched = true;
                        }
                        
                        // Set status based on match
                        csvStatus = matched ? '‡¶Æ‡¶ø‡¶≤‡ßá‡¶õ‡ßá' : '‡¶Æ‡¶ø‡¶≤‡ßá‡¶®‡¶ø';
                    }
                    // else: requested ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá csvStatus ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                } catch (e) {
                    console.error('CSV status check error:', e);
                }
                
                const totalVotersCsv = toBengaliNumber(row.vote_centre_total_voter || '');
                csv += `${toBengaliNumber(index + 1)},"${toBengaliNumber(row.officer_name || '')}","${officerType}","${toBengaliNumber(row.officer_iid || '')}","${toBengaliNumber(row.vote_centre_code || '')}","${toBengaliNumber(row.vote_centre_name || '')}","${toBengaliNumber(details.own_discrict || '')}","${toBengaliNumber(details.address || '')}","${toBengaliNumber(details.previous_election || '')}","${dob}","${totalVotersCsv}","${toBengaliNumber(details.comment || '')}","${createdDate}","${csvStatus}"\n`;
            });

            // Download CSV file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `assigned_officers_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
