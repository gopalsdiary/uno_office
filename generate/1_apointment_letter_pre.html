<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶™‡¶§‡ßç‡¶∞ - Appointment Letter</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .no-print {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 30px;
            margin: 0 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #38ef7d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 5px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: red;
        }

        .letter {
            margin-bottom: 15px;
            background: white;
            /* Force letter content to black text */
            color: #000;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 10px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Ensure all text inside generated letters is black (overrides inline/colorful styles) */
        .letter,
        .letter * {
            color: #000 !important;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }

            .no-print {
                display: none !important;
            }

            /* Allow multiple letters per printed page; allow splitting a single letter across pages when needed */
            .letter {
                margin-bottom: 0 !important;
            }

            /* Ensure printed letters are black */
            .letter,
            .letter * {
                color: #000 !important;
                -webkit-print-color-adjust: exact;
            }

            @page {
                margin: 0.5in;
            }

            /* Allow tables and rows to split across pages when needed (lets centres be cut across pages) */
            table,
            tr,
            td {
                /* no page-break-inside rules so tables may split when necessary */
            }
        }

        /* Duplicate Report Styles */
        .report-card {
            background: #fff;
            border: 2px solid #ff4d4d;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .report-card.success {
            border-color: #38ef7d;
        }

        .report-card h2 {
            margin-bottom: 15px;
            color: #d32f2f;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-card.success h2 {
            color: #2e7d32;
        }

        .duplicate-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .duplicate-table th,
        .duplicate-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .duplicate-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            background: #ff4d4d;
        }

        .type-badge {
            background: #667eea;
            margin-right: 5px;
        }

        @media print {
            .report-card {
                border-width: 1px;
                box-shadow: none;
                margin-bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="duplicateReport"></div>
        <div id="summaryReport"></div>
        <div id="appointmentContent">
            <div class="loading">
                <h2>‚è≥ Loading data...</h2>
            </div>
        </div>
    </div>

    <script>
        // Load all centres on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Duplicate Check v1.0-2026-02-07');
            checkAuth();
            try {
                const centres = await loadAllCentresData();
                renderAllLetters(centres);
            } catch (error) {
                console.error('Error loading centres:', error);
                document.getElementById('appointmentContent').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error loading data</h2>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="window.history.back()">Go Back</button>
                    </div>
                `;
            }
        });

        async function loadAllCentresData() {
            if (!window.supabaseClient) {
                throw new Error('Supabase client not initialized');
            }

            // Fetch all assignments with pagination to avoid row limits
            const assignments = await fetchAllAssignments();
            if (!assignments || assignments.length === 0) {
                throw new Error('No assignments found. Please generate and save first.');
            }

            // Generate Duplicate Report
            renderDuplicateReport(assignments);

            // Fetch requests to mark matching assignments
            const requests = await fetchAllRequests();
            const requestSet = new Set();
            if (requests) {
                requests.forEach(r => {
                    // Key: type_officerId_centreId
                    // Ensure ID types match (using string for safety). 
                    // assignment.officer_type matches request.officer_table_name ('presiding', 'ass_presiding', 'polling')
                    const key = `${r.officer_table_name}_${r.officer_table_iid}_${r.vote_centre_iid}`;
                    requestSet.add(key);
                });
            }

            // Group by centre code
            const centreMap = new Map();
            for (const assignment of assignments) {
                const code = assignment.vote_centre_code;
                if (!centreMap.has(code)) {
                    centreMap.set(code, {
                        centre: {
                            vote_centre_code: code,
                            vote_centre_iid: assignment.vote_centre_iid,
                            vote_centre_name: '',
                            vote_centre_location: '',
                            voter_both_male: 0,
                            voter_both_female: 0,
                            total_voter: ''
                        },
                        presiding: null,
                        assPresiding: [],
                        polling: []
                    });
                }

                // Check if this specific assignment was requested
                const reqKey = `${assignment.officer_type}_${assignment.officer_iid}_${assignment.vote_centre_iid}`;
                const isRequested = requestSet.has(reqKey);

                const bundle = centreMap.get(code);
                if (assignment.officer_type === 'presiding') {
                    bundle.presiding = {
                        presiding_iid: assignment.officer_iid,
                        presiding_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender,
                        isRequested: isRequested
                    };
                } else if (assignment.officer_type === 'ass_presiding') {
                    bundle.assPresiding.push({
                        ass_presiding_iid: assignment.officer_iid,
                        ass_presiding_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender,
                        booth_number: assignment.booth_number,
                        isRequested: isRequested
                    });
                } else if (assignment.officer_type === 'polling') {
                    bundle.polling.push({
                        polling_iid: assignment.officer_iid,
                        polling_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender,
                        booth_number: assignment.booth_number,
                        person_number: assignment.person_number,
                        isRequested: isRequested
                    });
                }
            }

            // Fetch centre meta for codes (normalize numeric strings to numbers for query)
            const codes = Array.from(centreMap.keys()).filter(Boolean);
            if (codes.length > 0) {
                const codesForQuery = codes.map(c => {
                    const n = Number(c);
                    return isNaN(n) ? String(c) : n;
                });

                const { data: centres, error: centreError } = await window.supabaseClient
                    .from('vote_centre')
                    .select('vote_centre_code, vote_centre_name, vote_centre_location, vote_centre_area, voter_both_male, voter_both_female, total_voter')
                    .in('vote_centre_code', codesForQuery);
                if (!centreError && centres) {
                    const meta = new Map();
                    centres.forEach(c => meta.set(String(c.vote_centre_code), c));
                    centreMap.forEach((bundle, code) => {
                        const c = meta.get(String(code));
                        if (c) {
                            bundle.centre.vote_centre_name = c.vote_centre_name || bundle.centre.vote_centre_name;
                            bundle.centre.vote_centre_location = c.vote_centre_location || bundle.centre.vote_centre_location;
                            bundle.centre.vote_centre_area = c.vote_centre_area || bundle.centre.vote_centre_area;
                            bundle.centre.voter_both_male = c.voter_both_male || 0;
                            bundle.centre.voter_both_female = c.voter_both_female || 0;
                            bundle.centre.total_voter = (c.total_voter !== undefined && c.total_voter !== null) ? c.total_voter : bundle.centre.total_voter;
                        }
                    });
                }
            }

            // Sort arrays inside
            centreMap.forEach(bundle => {
                bundle.assPresiding.sort((a, b) => (a.booth_number || 0) - (b.booth_number || 0));
                bundle.polling.sort((a, b) => {
                    if ((a.booth_number || 0) !== (b.booth_number || 0)) {
                        return (a.booth_number || 0) - (b.booth_number || 0);
                    }
                    return (a.person_number || 0) - (b.person_number || 0);
                });
            });

            // Return sorted by numeric centre code
            return Array.from(centreMap.values()).sort((a, b) => (Number(a.centre.vote_centre_code) || 0) - (Number(b.centre.vote_centre_code) || 0));
        }

        // Convert Arabic numerals to Bengali numerals (e.g., 1 -> ‡ßß)
        function toBengaliNumber(n) {
            const bengaliDigits = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
            return String(n).replace(/\d/g, d => bengaliDigits[Number(d)]);
        }

        // Fetch assignments with pagination (bypass Supabase 1000-row limit)
        async function fetchAllAssignments() {
            let all = [];
            let lastId = 0;
            const batchSize = 1000;
            let batch = 0;
            while (true) {
                batch++;
                const { data, error } = await window.supabaseClient
                    .from('centre_assignments')
                    .select('*')
                    .gt('assignment_id', lastId)
                    .order('assignment_id', { ascending: true })
                    .limit(batchSize);
                if (error) throw new Error(`Failed to load assignments (batch ${batch}): ${error.message}`);
                if (!data || data.length === 0) break;
                all.push(...data);
                lastId = data[data.length - 1].assignment_id;
                if (data.length < batchSize) break;
            }
            return all;
        }

        // Fetch requests from request_table
        async function fetchAllRequests() {
            let all = [];
            let lastId = 0;
            const batchSize = 1000;
            let batch = 0;
            while (true) {
                batch++;
                const { data, error } = await window.supabaseClient
                    .from('request_table')
                    .select('*')
                    .gt('request_id', lastId)
                    .order('request_id', { ascending: true })
                    .limit(batchSize);

                if (error) {
                    console.error('Error fetching requests:', error);
                    break; // or throw, but better to just return what we have or empty so we don't block the page
                }
                if (!data || data.length === 0) break;
                all.push(...data);
                lastId = data[data.length - 1].request_id;
                if (data.length < batchSize) break;
            }
            return all;
        }

        function getOfficerName(officer, type) {
            if (!officer) return '';
            // Fields from centre_assignments table
            if (type === 'presiding') return officer.presiding_name || officer.officer_name || officer.name || '';
            if (type === 'ass_presiding') return officer.ass_presiding_name || officer.officer_name || officer.name || '';
            if (type === 'polling') return officer.polling_name || officer.officer_name || officer.name || '';
            return officer.officer_name || officer.name || '';
        }

        function renderDuplicateReport(assignments) {
            const reportDiv = document.getElementById('duplicateReport');
            if (!assignments || assignments.length === 0) return;

            // Group by (type, iid) to find duplicates
            const counts = new Map();
            assignments.forEach(a => {
                const key = `${a.officer_type}_${a.officer_iid}`;
                if (!counts.has(key)) {
                    counts.set(key, {
                        officer: a,
                        assignments: []
                    });
                }
                counts.get(key).assignments.push(a);
            });

            const duplicates = Array.from(counts.values()).filter(group => group.assignments.length > 1);

            if (duplicates.length === 0) {
                reportDiv.innerHTML = `
                   
                `;
                return;
            }

            let html = `
                <div class="report-card">
                    <h2>‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶°‡ßÅ‡¶™‡¶≤‡¶ø‡¶ï‡ßá‡¶ü ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá! (${toBengaliNumber(duplicates.length)} ‡¶ú‡¶®)</h2>
                    <p>‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡¶∞‡¶æ ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶è‡¶∏‡¶æ‡¶á‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <div style="overflow-x: auto;">
                        <table class="duplicate-table">
                            <thead>
                                <tr>
                                    <th>‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶¶‡¶¨‡ßÄ</th>
                                    <th>‡¶ü‡¶æ‡¶á‡¶™</th>
                                    <th>‡¶è‡¶∏‡¶æ‡¶á‡¶®‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</th>
                                    <th>‡¶≠‡ßã‡¶ü‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (‡¶ï‡ßã‡¶° - ‡¶®‡¶æ‡¶Æ)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            duplicates.forEach(group => {
                const officer = group.officer;
                const assignedCentres = group.assignments.map(a =>
                    `‚Ä¢ ${toBengaliNumber(a.vote_centre_code)} - ${toBengaliNumber(a.vote_centre_name || 'N/A')}`
                ).join('<br>');

                let typeBn = officer.officer_type;
                if (typeBn === 'presiding') typeBn = '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç';
                else if (typeBn === 'ass_presiding') typeBn = '‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç';
                else if (typeBn === 'polling') typeBn = '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç';

                html += `
                    <tr>
                        <td>
                            <strong>${officer.officer_name}</strong><br>
                            <span style="font-size: 12px; color: #666;">${officer.officer_designation || ''}</span>
                        </td>
                        <td><span class="badge type-badge">${typeBn}</span></td>
                        <td style="text-align:center;"><span class="badge">${toBengaliNumber(group.assignments.length)} ‡¶ü‡¶ø</span></td>
                        <td style="font-size: 13px;">${assignedCentres}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            reportDiv.innerHTML = html;
        }

        function renderAllLetters(allData) {
            if (!allData || allData.length === 0) {
                document.getElementById('appointmentContent').innerHTML = '<div class="error"><h2>‚ùå No data to show</h2></div>';
                return;
            }

            // sort numerically by centre code
            allData.sort((a, b) => (Number(a.centre.vote_centre_code) || 0) - (Number(b.centre.vote_centre_code) || 0));

            const tableHtml = `
                <div class="report-card">
                    <h2 style="text-align:center; font-family: Nikosh;">‡¶≠‡ßã‡¶ü‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ì ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (‡ß®‡ß¨‡ß¨ ‡¶´‡ßá‡¶®‡ßÄ ‡ß®)</h2> 
                    <table class="duplicate-table" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: center; font-family: Nikosh; font-weight: bold; background-color: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 5px;">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶Ç</th>
                                <th style="border: 1px solid #000; padding: 5px;">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                <th style="border: 1px solid #000; padding: 5px;">‡¶è‡¶≤‡¶æ‡¶ï‡¶æ</th>
                                <th style="border: 1px solid #000; padding: 5px;">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶¶‡¶¨‡¶ø</th>
                                <th style="border: 1px solid #000; padding: 5px;">‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶¶‡¶¨‡¶ø</th>
                                <th style="border: 1px solid #000; padding: 5px;">‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allData.map(data => renderTableRow(data)).join('')}
                        </tbody>
                    </table>
                    <div class="no-print" style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            `;

            document.getElementById('appointmentContent').innerHTML = tableHtml;
        }

        function renderTableRow(data) {
            const centre = data.centre;
            const presiding = data.presiding;
            const assPresiding = data.assPresiding || [];
            
            // Get 1st Assistant Presiding Officer
            const firstAss = assPresiding.length > 0 ? assPresiding[0] : null;

            // Formatter for Presiding
            let presInfo = '';
            if (presiding) {
                const name = toBengaliNumber(getOfficerName(presiding, 'presiding'));
                const designation = presiding.designation ? toBengaliNumber(presiding.designation) : '';
                presInfo = `<span>${name}</span>`;
                if (designation) {
                    presInfo += `<br><span style="font-size: 12px;">${designation}</span>`;
                }
            }

            // Formatter for Assistant Presiding
            let assInfo = '';
            if (firstAss) {
                const name = toBengaliNumber(getOfficerName(firstAss, 'ass_presiding'));
                const designation = firstAss.designation ? toBengaliNumber(firstAss.designation) : '';
                assInfo = `<span>${name}</span>`;
                if (designation) {
                    assInfo += `<br><span style="font-size: 12px;">${designation}</span>`;
                }
            }

            return `
                <tr style="font-family: Nikosh;">
                    <td style="border: 1px solid #000; padding: 5px; text-align: center;">${toBengaliNumber(centre.vote_centre_code || '')}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${toBengaliNumber(centre.vote_centre_name || '')}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${toBengaliNumber(centre.vote_centre_area || '')}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${presInfo}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${assInfo}</td>
                    <td style="border: 1px solid #000; padding: 5px;"></td>
                </tr>
            `;
        }
    </script>
</body>

</html>