<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        h2 {
            color: #444;
            margin: 20px 0 15px 0;
            font-size: 22px;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }

        h3 {
            color: #555;
            margin: 15px 0 10px 0;
            font-size: 18px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .officer-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .officer-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .officer-card.selected {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .officer-info {
            flex: 1;
        }

        .officer-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .officer-details {
            font-size: 14px;
            color: #666;
        }

        .officer-actions {
            display: flex;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-presiding {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-ass-presiding {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-polling {
            background: #e8f5e9;
            color: #388e3c;
        }

        .reassignment-panel {
            display: none;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .reassignment-panel.active {
            display: block;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
        }

        .position-option {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .position-option:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .position-option.occupied {
            background: #ffe0e0;
            border-color: #ffcccb;
            cursor: not-allowed;
        }

        .position-option.selected {
            background: #d4edda;
            border-color: #28a745;
        }

        .position-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .position-occupant {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h1>
        
        <div class="status" id="status"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç...</p>
        </div>

        <div class="controls">
            <div class="form-group" style="min-width: 300px;">
                <label>üè¢ ‡¶â‡ßé‡¶∏ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="sourceCentreSelect" onchange="loadSourceCentre()">
                    <option value="">-- ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                </select>
            </div>
        </div>

        <div id="sourceCentreContainer" style="display: none;">
            <h2>üìã ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶ï‡ßÉ‡¶§ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞</h2>
            <div class="table-container">
                <table id="officersTable">
                    <thead>
                        <tr>
                            <th>‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</th>
                            <th>‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                            <th>‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶™‡¶¶‡¶¨‡¶ø</th>
                            <th>‡¶ß‡¶∞‡¶®</th>
                            <th>‡¶¨‡ßÅ‡¶• ‡¶®‡¶Ç</th>
                            <th>‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶®‡¶Ç</th>
                        </tr>
                    </thead>
                    <tbody id="officersTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="reassignmentPanel" class="reassignment-panel">
            <h2>üéØ ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
            <div id="selectedOfficerInfo"></div>

            <div class="form-group" style="margin-top: 20px;">
                <label>üè¢ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <select id="targetCentreSelect" onchange="loadTargetCentre()">
                    <option value="">-- ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                </select>
            </div>

            <div id="targetCentreContainer" style="display: none;">
                <h3>üìç ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶™‡¶¶‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
                <div id="availablePositions"></div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="confirmReassignment()">
                        ‚úÖ ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                    <button class="btn btn-danger" onclick="cancelReassignment()">
                        ‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadCentres();
        });

        let allCentres = [];
        let allAssignments = [];
        let selectedOfficer = null;
        let selectedPosition = null;

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function setLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        }

        async function loadCentres() {
            if (!window.supabaseClient) {
                showStatus('‚ùå Supabase client not initialized', 'error');
                return;
            }

            try {
                setLoading(true);

                // Load all centres
                const { data: centres, error: centresError } = await window.supabaseClient
                    .from('vote_centre')
                    .select('*')
                    .order('vote_centre_code');

                if (centresError) throw centresError;

                allCentres = centres || [];

                // Populate source centre dropdown
                const sourceSelect = document.getElementById('sourceCentreSelect');
                const targetSelect = document.getElementById('targetCentreSelect');
                
                sourceSelect.innerHTML = '<option value="">-- ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
                targetSelect.innerHTML = '<option value="">-- ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';

                allCentres.forEach(centre => {
                    const option1 = document.createElement('option');
                    option1.value = centre.vote_centre_iid;
                    option1.textContent = `${centre.vote_centre_code} - ${centre.vote_centre_name}`;
                    sourceSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = centre.vote_centre_iid;
                    option2.textContent = `${centre.vote_centre_code} - ${centre.vote_centre_name}`;
                    targetSelect.appendChild(option2);
                });

                // Load all assignments
                const { data: assignments, error: assignmentsError } = await window.supabaseClient
                    .from('centre_assignments')
                    .select('*')
                    .order('vote_centre_iid, officer_type, booth_number');

                if (assignmentsError) throw assignmentsError;

                allAssignments = assignments || [];

                showStatus('‚úÖ ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');

            } catch (error) {
                console.error('Load error:', error);
                showStatus(`‚ùå ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function loadSourceCentre() {
            const centreId = document.getElementById('sourceCentreSelect').value;
            
            if (!centreId) {
                document.getElementById('sourceCentreContainer').style.display = 'none';
                return;
            }

            try {
                setLoading(true);

                const centreAssignments = allAssignments.filter(a => a.vote_centre_iid == centreId);

                if (centreAssignments.length === 0) {
                    showStatus('‚ö†Ô∏è ‡¶è‡¶á ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶®‡ßá‡¶á', 'error');
                    document.getElementById('sourceCentreContainer').style.display = 'none';
                    return;
                }

                // Display officers table
                const tbody = document.getElementById('officersTableBody');
                tbody.innerHTML = '';

                centreAssignments.forEach(assignment => {
                    const row = document.createElement('tr');
                    
                    const badgeClass = 
                        assignment.officer_type === 'presiding' ? 'badge-presiding' :
                        assignment.officer_type === 'ass_presiding' ? 'badge-ass-presiding' :
                        'badge-polling';

                    const typeName = 
                        assignment.officer_type === 'presiding' ? '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç' :
                        assignment.officer_type === 'ass_presiding' ? '‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç' :
                        '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç';

                    row.innerHTML = `
                        <td>
                            <input type="radio" name="selectOfficer" value="${assignment.assignment_id}" 
                                onchange="selectOfficerForReassignment(${assignment.assignment_id})">
                        </td>
                        <td>${assignment.officer_iid}</td>
                        <td>${assignment.officer_name || 'N/A'}</td>
                        <td>${assignment.officer_designation || 'N/A'}</td>
                        <td><span class="badge ${badgeClass}">${typeName}</span></td>
                        <td>${assignment.booth_number || '-'}</td>
                        <td>${assignment.person_number || '-'}</td>
                    `;
                    
                    tbody.appendChild(row);
                });

                document.getElementById('sourceCentreContainer').style.display = 'block';

            } catch (error) {
                console.error('Load source centre error:', error);
                showStatus(`‚ùå ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        function selectOfficerForReassignment(assignmentId) {
            selectedOfficer = allAssignments.find(a => a.assignment_id === assignmentId);
            
            if (!selectedOfficer) return;

            const typeName = 
                selectedOfficer.officer_type === 'presiding' ? '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞' :
                selectedOfficer.officer_type === 'ass_presiding' ? '‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞' :
                '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞';

            document.getElementById('selectedOfficerInfo').innerHTML = `
                <div class="officer-card selected">
                    <div class="officer-info">
                        <div class="officer-name">‚úÖ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§: ${selectedOfficer.officer_name}</div>
                        <div class="officer-details">
                            ‡¶Ü‡¶á‡¶°‡¶ø: ${selectedOfficer.officer_iid} | 
                            ‡¶ß‡¶∞‡¶®: ${typeName} | 
                            ‡¶™‡¶¶‡¶¨‡¶ø: ${selectedOfficer.officer_designation || 'N/A'}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reassignmentPanel').classList.add('active');
            document.getElementById('targetCentreContainer').style.display = 'none';
            document.getElementById('targetCentreSelect').value = '';
            selectedPosition = null;
        }

        async function loadTargetCentre() {
            const targetCentreId = document.getElementById('targetCentreSelect').value;
            
            if (!targetCentreId) {
                document.getElementById('targetCentreContainer').style.display = 'none';
                return;
            }

            if (!selectedOfficer) {
                showStatus('‚ö†Ô∏è ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }

            // Don't allow reassigning to the same centre
            if (targetCentreId == selectedOfficer.vote_centre_iid) {
                showStatus('‚ö†Ô∏è ‡¶è‡¶ï‡¶á ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ', 'error');
                document.getElementById('targetCentreSelect').value = '';
                return;
            }

            try {
                setLoading(true);

                const targetCentre = allCentres.find(c => c.vote_centre_iid == targetCentreId);
                const targetAssignments = allAssignments.filter(a => a.vote_centre_iid == targetCentreId);

                // Generate available positions based on officer type
                const positionsHtml = [];

                if (selectedOfficer.officer_type === 'presiding') {
                    // Check if presiding position is occupied
                    const presidingOccupied = targetAssignments.find(a => a.officer_type === 'presiding');
                    
                    positionsHtml.push(`
                        <div class="position-option ${presidingOccupied ? 'occupied' : ''}" 
                            onclick="${presidingOccupied ? '' : 'selectPosition(\'presiding\', null, null)'}">
                            <div class="position-label">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞</div>
                            <div class="position-occupant">
                                ${presidingOccupied ? 
                                    `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¶‡¶ñ‡¶≤‡¶ï‡ßÉ‡¶§: ${presidingOccupied.officer_name}` : 
                                    '‚úÖ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß'}
                            </div>
                        </div>
                    `);
                } else if (selectedOfficer.officer_type === 'ass_presiding') {
                    // Show booth positions for assistant presiding
                    const totalBooths = targetCentre.voter_both_total || 1;
                    
                    for (let booth = 1; booth <= totalBooths; booth++) {
                        const boothOccupied = targetAssignments.find(a => 
                            a.officer_type === 'ass_presiding' && a.booth_number === booth
                        );
                        
                        positionsHtml.push(`
                            <div class="position-option ${boothOccupied ? 'occupied' : ''}" 
                                onclick="${boothOccupied ? '' : `selectPosition('ass_presiding', ${booth}, null)`}">
                                <div class="position-label">‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç - ‡¶¨‡ßÅ‡¶• ${booth}</div>
                                <div class="position-occupant">
                                    ${boothOccupied ? 
                                        `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¶‡¶ñ‡¶≤‡¶ï‡ßÉ‡¶§: ${boothOccupied.officer_name}` : 
                                        '‚úÖ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß'}
                                </div>
                            </div>
                        `);
                    }
                } else if (selectedOfficer.officer_type === 'polling') {
                    // Show booth and person positions for polling
                    const totalBooths = targetCentre.voter_both_total || 1;
                    
                    for (let booth = 1; booth <= totalBooths; booth++) {
                        for (let person = 1; person <= 2; person++) {
                            const pollingOccupied = targetAssignments.find(a => 
                                a.officer_type === 'polling' && 
                                a.booth_number === booth && 
                                a.person_number === person
                            );
                            
                            positionsHtml.push(`
                                <div class="position-option ${pollingOccupied ? 'occupied' : ''}" 
                                    onclick="${pollingOccupied ? '' : `selectPosition('polling', ${booth}, ${person})`}">
                                    <div class="position-label">‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ - ‡¶¨‡ßÅ‡¶• ${booth}, ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ${person}</div>
                                    <div class="position-occupant">
                                        ${pollingOccupied ? 
                                            `‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¶‡¶ñ‡¶≤‡¶ï‡ßÉ‡¶§: ${pollingOccupied.officer_name}` : 
                                            '‚úÖ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß'}
                                    </div>
                                </div>
                            `);
                        }
                    }
                }

                document.getElementById('availablePositions').innerHTML = positionsHtml.join('');
                document.getElementById('targetCentreContainer').style.display = 'block';

            } catch (error) {
                console.error('Load target centre error:', error);
                showStatus(`‚ùå ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        function selectPosition(type, boothNumber, personNumber) {
            // Remove previous selection
            document.querySelectorAll('.position-option').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selection to clicked element
            event.target.closest('.position-option').classList.add('selected');

            selectedPosition = {
                type: type,
                boothNumber: boothNumber,
                personNumber: personNumber
            };
        }

        async function confirmReassignment() {
            if (!selectedOfficer || !selectedPosition) {
                showStatus('‚ö†Ô∏è ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶¶ ‡¶â‡¶≠‡¶Ø‡¶º‡¶á ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }

            const targetCentreId = document.getElementById('targetCentreSelect').value;
            const targetCentre = allCentres.find(c => c.vote_centre_iid == targetCentreId);

            if (!targetCentre) {
                showStatus('‚ö†Ô∏è ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
                return;
            }

            const confirmMsg = `‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®:\n\n‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞: ${selectedOfficer.officer_name}\n‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶•‡ßá‡¶ï‡ßá\n‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞: ${targetCentre.vote_centre_name}\n\n‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?`;
            
            if (!confirm(confirmMsg)) return;

            try {
                setLoading(true);

                // Calculate new assign_code
                let newAssignCode = `${targetCentreId}`;
                if (selectedPosition.type === 'ass_presiding') {
                    newAssignCode = `${targetCentreId}-${selectedPosition.boothNumber}`;
                } else if (selectedPosition.type === 'polling') {
                    newAssignCode = `${targetCentreId}-${selectedPosition.boothNumber}-${selectedPosition.personNumber}`;
                }

                // Step 1: Delete old assignment
                const { error: deleteError } = await window.supabaseClient
                    .from('centre_assignments')
                    .delete()
                    .eq('assignment_id', selectedOfficer.assignment_id);

                if (deleteError) throw deleteError;

                // Step 2: Create new assignment
                const newAssignment = {
                    vote_centre_iid: parseInt(targetCentreId),
                    vote_centre_code: targetCentre.vote_centre_code,
                    officer_type: selectedPosition.type,
                    officer_iid: selectedOfficer.officer_iid,
                    officer_name: selectedOfficer.officer_name,
                    officer_designation: selectedOfficer.officer_designation,
                    officer_gender: selectedOfficer.officer_gender,
                    booth_number: selectedPosition.boothNumber,
                    person_number: selectedPosition.personNumber,
                    assign_code: newAssignCode,
                    created_at: new Date().toISOString()
                };

                const { error: insertError } = await window.supabaseClient
                    .from('centre_assignments')
                    .insert([newAssignment]);

                if (insertError) throw insertError;

                // Step 3: Update assign_code in officer table
                const tableName = 
                    selectedPosition.type === 'presiding' ? 'presiding_list' :
                    selectedPosition.type === 'ass_presiding' ? 'ass_presiding_list' :
                    'polling_list';

                const idColumn = 
                    selectedPosition.type === 'presiding' ? 'presiding_iid' :
                    selectedPosition.type === 'ass_presiding' ? 'ass_presiding_iid' :
                    'polling_iid';

                const { error: updateError } = await window.supabaseClient
                    .from(tableName)
                    .update({ assign_code: newAssignCode })
                    .eq(idColumn, selectedOfficer.officer_iid);

                if (updateError) throw updateError;

                showStatus('‚úÖ ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');

                // Refresh data
                await loadCentres();
                
                // Reset form
                document.getElementById('sourceCentreSelect').value = '';
                document.getElementById('targetCentreSelect').value = '';
                document.getElementById('sourceCentreContainer').style.display = 'none';
                document.getElementById('reassignmentPanel').classList.remove('active');
                selectedOfficer = null;
                selectedPosition = null;

            } catch (error) {
                console.error('Reassignment error:', error);
                showStatus(`‚ùå ‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        function cancelReassignment() {
            if (confirm('‡¶™‡ßÅ‡¶®‡¶É‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) {
                document.getElementById('reassignmentPanel').classList.remove('active');
                document.getElementById('targetCentreContainer').style.display = 'none';
                document.getElementById('targetCentreSelect').value = '';
                selectedOfficer = null;
                selectedPosition = null;
                
                // Uncheck radio buttons
                document.querySelectorAll('input[name="selectOfficer"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        }
    </script>
</body>
</html>
