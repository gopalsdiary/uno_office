<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶™‡¶§‡ßç‡¶∞ - Appointment Letter</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .no-print {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 30px;
            margin: 0 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #38ef7d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: red;
        }

        .letter {
            page-break-after: always;
            margin-bottom: 40px;
            background: white;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- Hidden template parts to avoid quoting issues in JS -->
    <script id="word-header"
        type="text/plain"><html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title><style>@page { size: 8.5in 14in; margin: 0.3in; } body { font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif; } table { border-collapse: collapse; width: 100%; border: 1px solid black; } td { border: 1px solid black; padding: 5px; } .letter { page-break-after: always; } </style></head><body></script>
    <script id="word-footer" type="text/plain"></body></html></script>

    <div class="container">

        <div class="no-print">
            <button onclick="exportToWord()" class="btn btn-success">üìù Download Word File</button>
        </div>

        <div id="appointmentContent">
            <div class="loading">
                <h2>‚è≥ Loading data...</h2>
            </div>
        </div>
    </div>

    <script>
        // Load all centres on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('1_apointment_copy.html v2026-01-05-all');
            if (typeof checkAuth === 'function') checkAuth();
            try {
                const centres = await loadAllCentresData();
                renderAllLetters(centres);
            } catch (error) {
                console.error('Error loading centres:', error);
                document.getElementById('appointmentContent').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error loading data</h2>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="window.history.back()">Go Back</button>
                    </div>
                `;
            }
        });

        async function loadAllCentresData() {
            if (!window.supabaseClient) {
                throw new Error('Supabase client not initialized');
            }

            const assignments = await fetchAllAssignments();
            if (!assignments || assignments.length === 0) {
                throw new Error('No assignments found. Please generate and save first.');
            }

            const centreMap = new Map();
            for (const assignment of assignments) {
                const code = assignment.vote_centre_code;
                if (!centreMap.has(code)) {
                    centreMap.set(code, {
                        centre: {
                            vote_centre_code: code,
                            vote_centre_iid: assignment.vote_centre_iid,
                            vote_centre_name: '',
                            vote_centre_location: '',
                            voter_both_male: 0,
                            voter_both_female: 0
                        },
                        presiding: null,
                        assPresiding: [],
                        polling: []
                    });
                }

                const bundle = centreMap.get(code);
                if (assignment.officer_type === 'presiding') {
                    bundle.presiding = {
                        presiding_iid: assignment.officer_iid,
                        presiding_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender
                    };
                } else if (assignment.officer_type === 'ass_presiding') {
                    bundle.assPresiding.push({
                        ass_presiding_iid: assignment.officer_iid,
                        ass_presiding_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender,
                        booth_number: assignment.booth_number
                    });
                } else if (assignment.officer_type === 'polling') {
                    bundle.polling.push({
                        polling_iid: assignment.officer_iid,
                        polling_name: assignment.officer_name,
                        designation: assignment.officer_designation,
                        gender: assignment.officer_gender,
                        booth_number: assignment.booth_number,
                        person_number: assignment.person_number
                    });
                }
            }

            const codes = Array.from(centreMap.keys()).filter(Boolean);
            if (codes.length > 0) {
                const codesForQuery = codes.map(c => {
                    const n = Number(c);
                    return isNaN(n) ? String(c) : n;
                });

                const { data: centres, error: centreError } = await window.supabaseClient
                    .from('vote_centre')
                    .select('vote_centre_code, vote_centre_name, vote_centre_location, voter_both_male, voter_both_female')
                    .in('vote_centre_code', codesForQuery);
                if (!centreError && centres) {
                    const meta = new Map();
                    centres.forEach(c => meta.set(String(c.vote_centre_code), c));
                    centreMap.forEach((bundle, code) => {
                        const c = meta.get(String(code));
                        if (c) {
                            bundle.centre.vote_centre_name = c.vote_centre_name || bundle.centre.vote_centre_name;
                            bundle.centre.vote_centre_location = c.vote_centre_location || bundle.centre.vote_centre_location;
                            bundle.centre.voter_both_male = c.voter_both_male || 0;
                            bundle.centre.voter_both_female = c.voter_both_female || 0;
                        }
                    });
                }
            }

            centreMap.forEach(bundle => {
                bundle.assPresiding.sort((a, b) => (a.booth_number || 0) - (b.booth_number || 0));
                bundle.polling.sort((a, b) => {
                    if ((a.booth_number || 0) !== (b.booth_number || 0)) {
                        return (a.booth_number || 0) - (b.booth_number || 0);
                    }
                    return (a.person_number || 0) - (b.person_number || 0);
                });
            });

            return Array.from(centreMap.values()).sort((a, b) => (Number(a.centre.vote_centre_code) || 0) - (Number(b.centre.vote_centre_code) || 0));
        }

        function toBengaliNumber(n) {
            const bengaliDigits = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
            return String(n || 0).replace(/\d/g, d => bengaliDigits[Number(d)]);
        }

        async function fetchAllAssignments() {
            let all = [];
            let lastId = 0;
            const batchSize = 1000;
            while (true) {
                const { data, error } = await window.supabaseClient
                    .from('centre_assignments')
                    .select('*')
                    .gt('assignment_id', lastId)
                    .order('assignment_id', { ascending: true })
                    .limit(batchSize);
                if (error) throw new Error(`Failed to load assignments: ${error.message}`);
                if (!data || data.length === 0) break;
                all.push(...data);
                lastId = data[data.length - 1].assignment_id;
                if (data.length < batchSize) break;
            }
            return all;
        }

        function getOfficerName(officer, type) {
            if (!officer) return '';
            return officer.officer_name || officer.presiding_name || officer.ass_presiding_name || officer.polling_name || officer.name || '';
        }

        function renderAllLetters(allData) {
            if (!allData || allData.length === 0) {
                document.getElementById('appointmentContent').innerHTML = '<div class="error"><h2>‚ùå No data to show</h2></div>';
                return;
            }
            const sections = allData.map(renderSingleLetter).join('');
            document.getElementById('appointmentContent').innerHTML = sections;
        }

        function renderSingleLetter(data) {
            const centre = data.centre;
            const presiding = data.presiding;
            const assPresiding = data.assPresiding || [];
            const polling = data.polling || [];

            let tableRows = '';
            const maxRows = Math.max(1, assPresiding.length);
            const firstAssPres = assPresiding.length > 0 ? assPresiding[0] : null;

            if (assPresiding.length === 0) {
                tableRows = `<tr><td rowspan="1" style="border:1px solid black; padding:5px; text-align:center;">${presiding ? toBengaliNumber(getOfficerName(presiding, 'presiding')) : 'N/A'}<br>${presiding && presiding.designation ? presiding.designation : ''}</td><td style="border:1px solid black;">&nbsp;</td><td style="border:1px solid black;">&nbsp;</td><td style="border:1px solid black;">&nbsp;</td></tr>`;
            } else {
                for (let i = 0; i < maxRows; i++) {
                    const assPres = assPresiding[i];
                    const poll1 = polling[i * 2];
                    const poll2 = polling[i * 2 + 1];
                    tableRows += `<tr>${i === 0 ? `<td rowspan="${maxRows}" style="border:1px solid black; padding:5px; text-align:center;">${presiding ? toBengaliNumber(getOfficerName(presiding, 'presiding')) : 'N/A'}<br>${presiding && presiding.designation ? presiding.designation : ''}</td>` : ''}<td style="border:1px solid black; padding:5px;">${assPres ? toBengaliNumber(i + 1) + '‡•§ ' + getOfficerName(assPres) + '<br>' + (assPres.designation || '') : ''}</td><td style="border:1px solid black; padding:5px;">${poll1 ? '‡ßß. ' + getOfficerName(poll1) + (poll1.designation ? ', ' + poll1.designation : '') + '<br>' : ''}${poll2 ? '‡ß®. ' + getOfficerName(poll2) + (poll2.designation ? ', ' + poll2.designation : '') : ''}</td>${i === 0 ? `<td rowspan="${maxRows}" style="border:1px solid black; padding:5px; text-align:center;">${firstAssPres ? getOfficerName(firstAssPres) : ''}<br>${firstAssPres && firstAssPres.designation ? firstAssPres.designation : ''}</td>` : ''}</tr>`;
                }
            }

            const maleCount = Number(centre.voter_both_male) || 0;
            const femaleCount = Number(centre.voter_both_female) || 0;
            const boothInfo = `‡¶Ø‡ßá ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶≠‡ßã‡¶ü‡¶æ‡¶∞‡¶ó‡¶£ ‡¶≠‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶∏‡ßá ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É ${centre.vote_centre_location || 'N/A'}${(maleCount > 0 || femaleCount > 0) ? ` (‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑ ‡¶¨‡ßÅ‡¶•-${toBengaliNumber(maleCount)} ‡¶ü‡¶ø, ‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ ‡¶¨‡ßÅ‡¶•-${toBengaliNumber(femaleCount)} ‡¶ü‡¶ø)` : ''}`;

            return `
                <div class="letter" style="margin-bottom:50px;">
                    <p style="text-align:right;"><strong>‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶Ç ‚Äì ${toBengaliNumber(centre.vote_centre_code)}</strong></p>
                    <p style="text-align:center; font-size:16pt;">‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂ ‡¶ú‡¶æ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∏‡¶Ç‡¶∏‡¶¶ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</p>
                    <p style="text-align:center; text-decoration:underline;">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞, ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶™‡¶§‡ßç‡¶∞</p>
                    <p>‡¶ú‡ßá‡¶≤‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É ‡¶´‡ßá‡¶®‡ßÄ, ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßÄ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ì ‡¶®‡¶æ‡¶Æ‡¶É ‡ß®‡ß¨‡ß¨, ‡¶´‡ßá‡¶®‡ßÄ-‡ß®</p>
                    <p>‡¶≠‡ßã‡¶ü‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶É ${centre.vote_centre_name || 'N/A'}</p>
                    <p>${boothInfo}</p>
                    <p style="text-align:justify; font-size:10pt;">‡¶ó‡¶£‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶®‡¶ø‡¶ß‡¶ø‡¶§‡ßç‡¶¨ ‡¶Ü‡¶¶‡ßá‡¶∂, 1972 ‡¶è‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶ö‡ßç‡¶õ‡ßá‡¶¶ 9 ‡¶è‡¶∞ ‡¶¶‡¶´‡¶æ (1‡¶ñ) ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï ‡¶Ö‡¶∞‡ßç‡¶™‡¶ø‡¶§ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ‡¶¨‡¶≤‡ßá, ‡¶Ü‡¶Æ‡¶ø ‡¶Æ‡¶®‡¶ø‡¶∞‡¶æ ‡¶π‡¶ï, ‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶ï, ‡¶´‡ßá‡¶®‡ßÄ ‡¶ì 266, ‡¶´‡ßá‡¶®‡ßÄ-2 ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡¶ø ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶£‡¶ï‡ßá ‡¶â‡¶™‡¶∞‡ßã‡¶≤‡ßç‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶§‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞, ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡¶ï‡ßá ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø‡¶≤‡¶æ‡¶Æ:</p>
                    <table style="width:100%; border-collapse:collapse; border:1px solid black; margin-top:10px;">
                        <thead><tr style="background:#eee;"><th style="border:1px solid black;">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</th><th style="border:1px solid black;">‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</th><th style="border:1px solid black;">‡¶™‡ßã‡¶≤‡¶ø‡¶Ç</th><th style="border:1px solid black;">‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶§‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <div style="margin-top:20px; border-top:1px solid black; padding-top:10px;">
                        <p style="text-align:center;">‡¶Ö‡¶Ç‡¶ó‡ßÄ‡¶ï‡¶æ‡¶∞‡¶®‡¶æ‡¶Æ‡¶æ</p>
                        <p>‡¶Ü‡¶Æ‡¶ø ................................. ‡¶â‡¶™‡¶∞‡ßá ‡¶¨‡¶∞‡ßç‡¶£‡¶ø‡¶§ ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶ó‡ßç‡¶∞‡¶π‡¶® ‡¶ï‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶ô‡ßç‡¶ó‡ßÄ‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø‡¶§‡ßá‡¶õ‡¶ø ‡¶Ø‡ßá, ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶™‡¶ø‡¶§ ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶æ‡¶≤‡¶® ‡¶ï‡¶∞‡¶ø‡¶¨‡•§</p>
                        <p style="text-align:right; margin-top:20px;">‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞: .................................</p>
                    </div>
                </div>
            `;
        }

        function exportToWord() {
            const header = document.getElementById('word-header').innerHTML;
            const footer = document.getElementById('word-footer').innerHTML;
            const content = document.getElementById("appointmentContent").innerHTML;
            const html = header + content + footer;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = 'appointment_letters.doc';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>