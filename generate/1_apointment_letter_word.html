<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡¶™‡¶§‡ßç‡¶∞ - Appointment Letter (Word Export)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        /* Base styles for premium preview matching 1_apointment_letter.html */
        @page {
            size: 8.5in 14in;
            margin: 0.25in 0.2in;
        }

        * {
            font-family: "Nikosh", "Vrinda", serif !important;
            box-sizing: border-box;
        }

        body {
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .no-print {
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 1000;
        }

        .btn {
            padding: 12px 35px;
            margin: 0 8px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }

        .page-container {
            background: white;
            width: 8.5in;
            min-height: 14in;
            padding: 0.25in 0.2in;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            margin: 0 auto 40px;
            position: relative;
            border: 1px solid #ddd;
        }

        .letter {
            page-break-after: always;
            clear: both;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 5px;
        }

        td {
            border: 1px solid #000;
            padding: 4px;
            vertical-align: top;
        }

        p {
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .bold {
            font-weight: bold;
        }

        .center {
            text-align: center;
        }

        .justify {
            text-align: justify;
        }

        .size-13 {
            font-size: 13pt;
        }

        .size-14 {
            font-size: 14pt;
        }

        .size-16 {
            font-size: 16pt;
        }

        .size-11 {
            font-size: 11pt;
        }

        .size-10 {
            font-size: 10pt;
        }

        @media print {
            body {
                background: none;
                padding: 0;
            }

            .page-container {
                box-shadow: none;
                border: none;
                margin: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="no-print">
        <button onclick="exportToWord()" class="btn btn-success">üìù Download All Letters (Word)</button>
        <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Print Preview</button>
    </div>

    <!-- Hidden Word XML Templates -->
    <script id="word-header" type="text/plain">
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
            <meta charset='utf-8'>
            <style>
                @page { size: 8.5in 14in; margin: 0.25in 0.2in; } 
                body { font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif; font-size: 11pt; } 
                table { border-collapse: collapse; width: 100%; border: 0.5pt solid black; margin-bottom: 5pt; } 
                td { border: 0.5pt solid black; padding: 3pt; vertical-align: top; }
                .letter { page-break-after: always; clear: both; }
                p { margin: 0; padding: 0; line-height: 1.0; }
                .bold { font-weight: bold; }
                .center { text-align: center; }
                .size-13 { font-size: 13pt; }
                .size-14 { font-size: 14pt; }
                .size-16 { font-size: 16pt; }
            </style>
        </head>
        <body>
    </script>
    <script id="word-footer" type="text/plain"></body></html></script>

    <div id="appointmentContent">
        <div class="page-container">
            <h2 class="center" style="padding: 100px;">‚è≥ Loading All Appointment Letters...</h2>
        </div>
    </div>

    <script>
        const bengaliDigits = '‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ';
        function toBengaliNumber(n) {
            return String(n || 0).replace(/\d/g, d => bengaliDigits[Number(d)]);
        }

        async function fetchAllData() {
            if (!window.supabaseClient) throw new Error('Supabase client not initialized');

            // 1. Fetch Centres
            const { data: centres, error: cErr } = await window.supabaseClient.from('vote_centre').select('*').order('vote_centre_code');
            if (cErr) throw cErr;

            // 2. Fetch All Assignments
            let allAssignments = [], lastId = 0;
            while (true) {
                const { data, error } = await window.supabaseClient.from('centre_assignments').select('*').gt('assignment_id', lastId).order('assignment_id').limit(1000);
                if (error || !data || data.length === 0) break;
                allAssignments.push(...data);
                lastId = data[data.length - 1].assignment_id;
            }

            // Group assignments by centre code
            const assignMap = {};
            allAssignments.forEach(a => {
                if (!assignMap[a.vote_centre_code]) assignMap[a.vote_centre_code] = { presiding: null, assPresiding: [], polling: [] };
                const bundle = assignMap[a.vote_centre_code];
                if (a.officer_type === 'presiding') bundle.presiding = a;
                else if (a.officer_type === 'ass_presiding') bundle.assPresiding.push(a);
                else if (a.officer_type === 'polling') bundle.polling.push(a);
            });

            return centres.map(c => ({
                centre: c,
                assignments: assignMap[c.vote_centre_code] || { presiding: null, assPresiding: [], polling: [] }
            }));
        }

        function renderLetter(data) {
            const { centre, assignments } = data;
            const { presiding, assPresiding, polling } = assignments;

            assPresiding.sort((a, b) => (a.booth_number || 0) - (b.booth_number || 0));
            polling.sort((a, b) => (a.booth_number || 0) - (b.booth_number || 0) || (a.person_number || 0) - (b.person_number || 0));

            const format = (o) => o ? `${o.officer_name}${o.officer_designation ? `, ${o.officer_designation}` : ''}` : '';

            let tableRows = '';
            const totalAss = Math.max(1, assPresiding.length);
            const totalRows = totalAss * 2;

            for (let i = 0; i < totalAss; i++) {
                const p1 = polling[i * 2], p2 = polling[i * 2 + 1], ass = assPresiding[i];
                tableRows += `
                    <tr>
                        ${i === 0 ? `<td rowspan="${totalRows}" class="center" style="vertical-align:middle; width:20%;">${format(presiding)}</td>` : ''}
                        <td rowspan="2" class="center" style="vertical-align:middle; width:4%;">${toBengaliNumber(i + 1)}</td>
                        <td rowspan="2" style="vertical-align:middle; width:24%;">${format(ass)}</td>
                        <td class="center" style="width:4%;">${toBengaliNumber(1)}</td>
                        <td style="width:30%;">${format(p1)}</td>
                        ${i === 0 ? `<td rowspan="${totalRows}" class="center" style="vertical-align:middle; width:18%;">${format(assPresiding[0])}</td>` : ''}
                    </tr>
                    <tr>
                        <td class="center">${toBengaliNumber(2)}</td>
                        <td>${format(p2)}</td>
                    </tr>
                `;
            }

            return `
            <div class="page-container letter">
                <table style="border:none;">
                    <tr>
                        <td style="border:none; width:100px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Government_Seal_of_Bangladesh.svg/1024px-Government_Seal_of_Bangladesh.svg.png" width="60" />
                        </td>
                        <td class="center" style="border:none;">
                            <p class="bold size-13">‡¶ó‡¶£‡¶™‡ßç‡¶∞‡¶ú‡¶æ‡¶§‡¶®‡ßç‡¶§‡ßç‡¶∞‡ßÄ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞</p>
                            <p class="bold">‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßü ‡¶ì ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßü, ‡¶´‡ßá‡¶®‡ßÄ</p>
                            <p class="bold size-14">‡¶§‡ßç‡¶∞‡ßü‡ßã‡¶¶‡¶∂ ‡¶ú‡¶æ‡¶§‡ßÄ‡ßü ‡¶∏‡¶Ç‡¶∏‡¶¶ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® - ‡ß®‡ß¶‡ß®‡ß¨</p>
                        </td>
                        <td class="center" style="border:none; width:120px;">
                            <p class="size-16">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶®‡¶Ç- <b>${toBengaliNumber(centre.vote_centre_code)}</b></p>
                        </td>
                    </tr>
                </table>

                <p class="center bold size-13" style="margin: 10pt 0;">‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞, ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶®‡¶ø‡ßü‡ßã‡¶ó‡¶™‡¶§‡ßç‡¶∞</p>

                <table>
                    <tr>
                        <td class="bold">‡¶ú‡ßá‡¶≤‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É ‡¶´‡ßá‡¶®‡ßÄ</td>
                        <td class="bold">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡¶ø ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶É ‡ß®‡ß¨‡ß¨ ‡¶´‡ßá‡¶®‡ßÄ-‡ß®</td>
                    </tr>
                </table>

                <table>
                    <tr>
                        <td colspan="3"><b>‡¶≠‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶É</b> ${centre.vote_centre_code}, ${centre.vote_centre_name}, ${centre.vote_centre_location}, ‡¶´‡ßá‡¶®‡ßÄ ‡¶∏‡¶¶‡¶∞</td>
                        <td style="width:150px;"><b>‡¶ß‡¶∞‡¶£‡¶É</b> ${centre.vote_centre_quality || ''}</td>
                    </tr>
                </table>

                <table class="center">
                    <tr class="bold">
                        <td rowspan="2" style="width:40%;">‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</td>
                        <td colspan="3">‡¶≠‡ßã‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</td>
                        <td rowspan="2">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßÅ‡¶• ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</td>
                    </tr>
                    <tr class="bold">
                        <td>‡¶™‡ßÅ‡¶∞‡ßÅ‡¶∑</td><td>‡¶Æ‡¶π‡¶ø‡¶≤‡¶æ</td><td>‡¶Æ‡ßã‡¶ü</td>
                    </tr>
                    <tr>
                        <td>${centre.vote_centre_location || ''}</td>
                        <td>${toBengaliNumber(centre.male_voter)}</td>
                        <td>${toBengaliNumber(centre.female_voter)}</td>
                        <td><b>${toBengaliNumber(centre.total_voter)}</b></td>
                        <td class="bold">${toBengaliNumber(centre.voter_both_total)} ‡¶ü‡¶ø</td>
                    </tr>
                </table>

                <p class="justify size-11" style="margin: 8pt 0;">
                    ‡¶ó‡¶£‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶®‡¶ø‡¶ß‡¶ø‡¶§‡ßç‡¶¨ ‡¶Ü‡¶¶‡ßá‡¶∂, ‡ßß‡ßØ‡ß≠‡ß® ‡¶è‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶ö‡ßç‡¶õ‡ßá‡¶¶ ‡ßØ ‡¶è‡¶∞ ‡¶¶‡¶´‡¶æ (‡ßß‡¶ñ) ‡¶¨‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶Æ‡¶®‡¶ø‡¶∞‡¶æ ‡¶π‡¶ï, ‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶ï ‡¶ì ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞, ‡ß®‡ß¨‡ß¨ ‡¶´‡ßá‡¶®‡ßÄ-‡ß® ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶¨‡¶∞‡ßç‡¶£‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶£‡¶ï‡ßá ‡¶â‡¶™‡¶∞‡ßã‡¶≤‡ßç‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶≠‡ßã‡¶ü‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶®‡¶ø‡ßü‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø‡¶≤‡¶æ‡¶Æ‡¶É
                </p>

                <table>
                    <tr class="center bold">
                        <td>‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞</td>
                        <td colspan="2">‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç</td>
                        <td colspan="2">‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞</td>
                        <td>‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶§‡ßá ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨ ‡¶™‡¶æ‡¶≤‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ</td>
                    </tr>
                    <tr class="center bold" style="font-size:9pt;"><td>‡ß¶‡ßß</td><td colspan="2">‡ß¶‡ß®</td><td colspan="2">‡ß¶‡ß©</td><td>‡ß¶‡ß™</td></tr>
                    ${tableRows}
                </table>

                <table style="margin-top:20pt; border:none;">
                    <tr>
                        <td style="border:none;">
                            <p>‡¶∏‡ßç‡¶•‡¶æ‡¶®: ‡¶´‡ßá‡¶®‡ßÄ</p>
                            <p>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ‡ßß‡ßß/‡ß¶‡ß®/‡ß®‡ß¶‡ß®‡ß¨</p>
                        </td>
                        <td class="center" style="border:none;">
                            <p><b>(‡¶Æ‡¶®‡¶ø‡¶∞‡¶æ ‡¶π‡¶ï)</b></p>
                            <p>‡¶ú‡ßá‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶∏‡¶ï, ‡¶´‡ßá‡¶®‡ßÄ ‡¶ì ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶Ö‡¶´‡¶ø‡¶∏‡¶æ‡¶∞</p>
                        </td>
                    </tr>
                </table>

                <div style="border-top: 1px dotted #000; margin-top:20pt; padding-top:10pt;">
                    <p class="center bold">‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§‡¶ø ‡¶∏‡ßç‡¶¨‡ßÄ‡¶ï‡¶æ‡¶∞ ‡¶ì ‡¶Ö‡¶ô‡ßç‡¶ó‡ßÄ‡¶ï‡¶æ‡¶∞‡¶®‡¶æ‡¶Æ‡¶æ</p>
                    <p class="justify" style="margin-top:5pt;">‡¶Ü‡¶Æ‡¶ø ................................................., ‡¶®‡¶ø‡ßü‡ßã‡¶ó ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶ô‡ßç‡¶ó‡ßÄ‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶Ø‡ßá, ‡¶Ö‡¶∞‡ßç‡¶™‡¶ø‡¶§ ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨ ‡¶∏‡¶§‡¶§‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶æ‡¶≤‡¶® ‡¶ï‡¶∞‡¶¨‡•§</p>
                    <p style="margin-top:10pt;"><b>‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞:</b> ${toBengaliNumber(centre.vote_centre_code)} - ${centre.vote_centre_name}</p>
                </div>
            </div>`;
        }

        async function init() {
            try {
                const allData = await fetchAllData();
                const html = allData.map(renderLetter).join('');
                document.getElementById('appointmentContent').innerHTML = html;
            } catch (err) {
                document.getElementById('appointmentContent').innerHTML = `<div class="error">Error: ${err.message}</div>`;
            }
        }

        function exportToWord() {
            const header = document.getElementById('word-header').innerHTML;
            const footer = document.getElementById('word-footer').innerHTML;
            const content = document.getElementById("appointmentContent").innerHTML;
            const blob = new Blob(['\ufeff', header + content + footer], { type: 'application/msword' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = 'All_Appointment_Letters.doc';
            link.click();
        }

        window.onload = init;
    </script>
</body>

</html>