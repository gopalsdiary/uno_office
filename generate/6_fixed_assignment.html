<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment to Specific Voting Centre</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: #f4f6f8;
            color: #0f172a;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 98%;
            margin: 10px auto;
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
            border: 1px solid #e6e9ee;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (min-width: 900px) {
            .form-grid {
                grid-template-columns: 1fr 360px; /* main form + side panel */
                align-items: start;
                gap: 24px;
            }
        }

        .form-main { }
        .form-side {
            background: #ffffff;
            border: 1px solid #e6eef6;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(15,23,42,0.04);
            min-width: 260px;
        }

        .selected-officer {
            display: none; /* shown when an officer is selected */
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #0f172a;
        }

        .form-group { margin-bottom: 12px; }
        .form-actions { justify-content: flex-start; gap: 12px; padding-top: 8px; }

        .search-row { display:flex; gap:10px; }
        .search-row input { flex:1; }
        .search-row button { white-space: nowrap; }
        .side-small { font-size: 13px; color: #64748b; margin-top: 10px; }
        .btn-sm { padding: 6px 10px; font-size: 13px; }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            font-size: 13px;
        }

        .data-table th {
            background: #f1f5f9;
            color: #0f172a;
            padding: 10px 8px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            white-space: nowrap;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            border-bottom: 1px solid #e6eef6;
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 15px;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 200px;
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 6px;
        }

        /* Make action column buttons compact and prevent text wrap */
        .action-btns .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            font-size: 12px;
            line-height: 1;
            white-space: nowrap; /* prevent wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 48px; /* ensure enough space to show short labels */
            height: 30px;
            border-radius: 6px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: bold;
            color: #333;
        }

        .search-result-id {
            color: #666;
            font-size: 14px;
        }

        .selected-officer {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
        }

        .selected-officer strong {
            color: #0c5460;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge.presiding {
            background: #d4edda;
            color: #155724;
        }

        .badge.ass-presiding {
            background: #fff3cd;
            color: #856404;
        }

        .badge.polling {
            background: #f8d7da;
            color: #721c24;
        }

        .matched-tick {
            color: #1e90ff;
            font-weight: bold;
            font-size: 18px;
        }

        /* Sort icon */
        .sort-icon {
            margin-left: 8px;
            font-size: 12px;
            color: #64748b;
        }

        /* Print: only show table */
        @media print {
            /* Hide everything */
            body * { visibility: hidden !important; }
            /* Show table container and its contents */
            .table-container, .table-container * { visibility: visible !important; }
            /* Move table to top-left and full width */
            .table-container { position: absolute !important; left: 0; top: 0; width: 100%; padding: 0 10px; }
            /* Ensure table uses full width and no rounded corners */
            .data-table { width: 100% !important; border-radius: 0 !important; }
            /* Remove shadows and backgrounds for printing */
            .container, .form-section, .form-side { box-shadow: none !important; background: transparent !important; border: none !important; }

            /* Hide action buttons and the Actions column (header + cells) */
            .action-btns { display: none !important; }
            .data-table th:last-child,
            .data-table td:last-child { display: none !important; }

            /* Hide Comment/Ref (12th) and Date (13th) columns */
            .data-table th:nth-child(12),
            .data-table td:nth-child(12),
            .data-table th:nth-child(13),
            .data-table td:nth-child(13) { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó≥Ô∏è Assignment to Specific Voting Centre</h1>
        
        <div class="status" id="status"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing... please wait...</p>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <h2 id="formTitle">Add New Entry</h2>
            
            <form id="assignmentForm">
                <input type="hidden" id="requestId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="officerType">Officer Type *</label>
                        <select id="officerType" required onchange="loadOfficersByType()" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                            <option value="">-- Select Officer Type --</option>
                            <option value="presiding">Presiding</option>
                            <option value="ass_presiding">Ass. Presiding</option>
                            <option value="polling">Polling</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="officerDropdown">Select Officer from List</label>
                        <select id="officerDropdown" onchange="selectOfficerFromDropdown()" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;">
                            <option value="">-- Select officer type first --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="officerSearch">Or Search by name/mobile/ID</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="officerSearch" placeholder="Type name or mobile/ID..." style="flex: 1;" onkeydown="handleSearchKeydown(event)">
                            <button type="button" class="btn btn-primary" onclick="searchOfficers()" style="padding: 12px 20px;">Search</button>
                        </div>
                        <input type="hidden" id="officerSelect" required>
                        <div id="searchResults" style="max-height: 260px; overflow-y: auto; margin-top: 10px; border: 2px solid #ddd; border-radius: 8px; display: none; background: white;"></div>
                    </div>

                    <div class="form-group">
                        <label for="officerName">Officer Name *</label>
                        <input type="text" id="officerName" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="voteCentreSelect">Vote Centre *</label>
                        <select id="voteCentreSelect" required onchange="loadCentreDetails()">
                            <option value="">-- Select --</option>
                        </select>
                    </div> 

                    <div class="form-group">
                        <label for="voteCentreCode">Centre Code</label>
                        <input type="text" id="voteCentreCode" readonly>
                    </div>

                    <div class="form-group">
                        <label for="voteCentreName">Centre Name</label>
                        <input type="text" id="voteCentreName" readonly>
                    </div>

                    <div class="form-group" id="commentGroup">
                        <label for="requestComment">Request/Comment *</label>
                        <textarea id="requestComment" required rows="3" placeholder="Write comment..." style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                        <span id="submitBtnText">üíæ Save</span>
                    </button>
                    <button type="button" class="btn btn-warning" onclick="resetForm()">
                        üîÑ Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Table Section -->
        <div class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                <h2 style="margin: 0; color: #667eea;">üìã Saved Records</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                    <button class="btn btn-primary btn-sm" onclick="filterByType('all')" id="filterAll" style="background: #667eea;">All</button>
                    <button class="btn btn-primary btn-sm" onclick="filterByType('presiding')" id="filterPresiding">Presiding</button>
                    <button class="btn btn-primary btn-sm" onclick="filterByType('ass_presiding')" id="filterAssPresiding">Ass. Presiding</button>
                    <button class="btn btn-primary btn-sm" onclick="filterByType('polling')" id="filterPolling">Polling</button>
                    <button class="btn btn-primary btn-sm" onclick="printTable()" id="printTableBtn" style="background:#0f172a;">üñ®Ô∏è Print Table</button>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Officer Name</th>
                        <th>Officer Type</th>
                        <th onclick="sortByColumn('officer_table_iid')" style="cursor: pointer;">Off Sl <span id="sortIcon_officer_table_iid" class="sort-icon">‚áÖ</span></th>
                        <th onclick="sortByColumn('vote_centre_code')" style="cursor: pointer;">Centre Code <span id="sortIcon_vote_centre_code" class="sort-icon">‚áÖ</span></th> 
                        <th>Centre Name</th>
                        <th>District</th>
                        <th>Address</th>
                        <th>Previous Election</th>
                        <th>DOB</th>
                        <th>Total Voter</th>
                        <th>Comment/Ref</th>
                        <th>Date</th>
                        <th style="text-align: center">Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 20px;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadVoteCentres();
            loadTableData();
        });

        let officerData = {};
        let voteCentreData = {};
        let isEditMode = false;
        let allOfficers = [];
        let searchResultsData = [];
        let selectedOfficer = null;
        let currentFilterType = 'all'; // Filter state
        let allTableData = []; // Store all data for filtering

        // Sorting state
        let currentSortColumn = null; // e.g. 'officer_table_iid' or 'vote_centre_code'
        let currentSortDirection = 'asc'; // 'asc' | 'desc' 

        // Helper function to show status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Show/hide loading
        function setLoading(isLoading) {
            const loading = document.getElementById('loading');
            loading.style.display = isLoading ? 'block' : 'none';
        }

        // Get officer type label in Bengali
        function getOfficerTypeLabel(type) {
            const labels = {
                'presiding': 'Presiding',
                'ass_presiding': 'Ass. Presiding',
                'polling': 'Polling'
            };
            return labels[type] || type;
        }



        // Search officers across all tables (server-side, like postal_ballet)
        async function searchOfficers() {
            const searchTerm = document.getElementById('officerSearch').value.trim();
            const officerType = document.getElementById('officerType').value;
            const resultsContainer = document.getElementById('searchResults');

            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                showStatus('Please enter a name or mobile number.', 'error');
                return;
            }

            setLoading(true);
            searchResultsData = [];

            try {
                // Fetch assigned officers from request_table
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let assignedData = [];
                
                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('request_table')
                        .select('officer_table_iid, officer_table_name')
                        .range(from, from + CHUNK - 1);
                    
                    if (error) throw error;
                    
                    const chunk = data || [];
                    assignedData.push(...chunk);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (assignedData.length >= MAX_FETCH) break;
                }
                
                // Create a Map of assigned officer IDs grouped by type
                const assignedOfficerIds = {
                    presiding: new Set(),
                    ass_presiding: new Set(),
                    polling: new Set()
                };
                
                assignedData.forEach(record => {
                    if (record.officer_table_iid && record.officer_table_name) {
                        if (assignedOfficerIds[record.officer_table_name]) {
                            assignedOfficerIds[record.officer_table_name].add(String(record.officer_table_iid));
                        }
                    }
                });
                
                console.log(`Assigned officers: Presiding=${assignedOfficerIds.presiding.size}, Ass.Presiding=${assignedOfficerIds.ass_presiding.size}, Polling=${assignedOfficerIds.polling.size}`);

                // presiding
                if (!officerType || officerType === 'presiding') {
                    const { data: presidingData, error: presidingError } = await window.supabaseClient
                        .from('presiding_list')
                        .select('*')
                        .or(`presiding_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                    if (presidingError) throw presidingError;
                    if (presidingData && presidingData.length) {
                        presidingData.forEach(off => {
                            // Filter out assigned officers
                            if (!assignedOfficerIds.presiding.has(String(off.presiding_iid))) {
                                searchResultsData.push({
                                    ...off,
                                    table: 'presiding_list',
                                    iid: off.presiding_iid,
                                    name: off.presiding_name,
                                    mobile: off.mobile_number || '',
                                    designation: off.presiding_designation || ''
                                });
                            }
                        });
                    }
                }

                // ass_presiding
                if (!officerType || officerType === 'ass_presiding') {
                    const { data: assData, error: assError } = await window.supabaseClient
                        .from('ass_presiding_list')
                        .select('*')
                        .or(`ass_presiding_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                    if (assError) throw assError;
                    if (assData && assData.length) {
                        assData.forEach(off => {
                            // Filter out assigned officers
                            if (!assignedOfficerIds.ass_presiding.has(String(off.ass_presiding_iid))) {
                                searchResultsData.push({
                                    ...off,
                                    table: 'ass_presiding_list',
                                    iid: off.ass_presiding_iid,
                                    name: off.ass_presiding_name,
                                    mobile: off.mobile_number || '',
                                    designation: off.ass_presiding_designation || ''
                                });
                            }
                        });
                    }
                }

                // polling
                if (!officerType || officerType === 'polling') {
                    const { data: pollData, error: pollError } = await window.supabaseClient
                        .from('polling_list')
                        .select('*')
                        .or(`polling_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                    if (pollError) throw pollError;
                    if (pollData && pollData.length) {
                        pollData.forEach(off => {
                            // Filter out assigned officers
                            if (!assignedOfficerIds.polling.has(String(off.polling_iid))) {
                                searchResultsData.push({
                                    ...off,
                                    table: 'polling_list',
                                    iid: off.polling_iid,
                                    name: off.polling_name,
                                    mobile: off.mobile_number || '',
                                    designation: off.polling_designation || ''
                                });
                            }
                        });
                    }
                }

                displaySearchResults();

            } catch (error) {
                console.error('Search error:', error);
                showStatus('Search error: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Display unified search results
        function displaySearchResults() {
            const resultsContainer = document.getElementById('searchResults');

            if (searchResultsData.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">No results found</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            let html = '';
            searchResultsData.slice(0,50).forEach((item, idx) => {
                html += `
                    <div class="search-result-item" onclick="selectOfficerFromResults(${idx})">
                        <div class="search-result-name">${item.name}</div>
                        <div class="search-result-id">ID: ${item.iid} | ${getOfficerTypeLabelByTable(item.table)}</div>
                    </div>
                `;
            });

            if (searchResultsData.length > 50) {
                html += '<div style="padding: 12px; text-align: center; color: #666; font-size: 14px;">More ' + (searchResultsData.length - 50) + ' results... refine search</div>';
            }

            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function getOfficerTypeLabelByTable(table) {
            if (table === 'presiding_list') return 'Presiding';
            if (table === 'ass_presiding_list') return 'Ass. Presiding';
            if (table === 'polling_list') return 'Polling';
            return table;
        }

        // Select officer from unified results
        function selectOfficerFromResults(index) {
            const officer = searchResultsData[index];
            if (!officer) return;

            const short = (officer.table === 'presiding_list') ? 'presiding' : (officer.table === 'ass_presiding_list') ? 'ass_presiding' : (officer.table === 'polling_list') ? 'polling' : officer.table;
            officer.type = short; // short name used for saving (e.g., 'presiding')
            selectedOfficer = officer;

            document.getElementById('officerSelect').value = officer.iid;
            document.getElementById('officerName').value = officer.name || '';
            document.getElementById('officerSearch').value = '';
            // clear existing comment so user must provide one
            document.getElementById('requestComment').value = '';
            document.getElementById('requestComment').focus();
            document.getElementById('searchResults').style.display = 'none';

            // Update side panel summary
            const box = document.getElementById('selectedOfficerBox');
            if (box) {
                document.getElementById('selName').textContent = officer.name || '-';
                document.getElementById('selType').textContent = getOfficerTypeLabel(officer.type) || '';
                document.getElementById('selContact').textContent = officer.mobile ? ('Mobile: ' + officer.mobile) : '';
                box.style.display = 'block';
            }
        }

        // Handle Enter key in search box
        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchOfficers();
            }
        }

        // Load officers by selected type into dropdown
        async function loadOfficersByType() {
            const officerType = document.getElementById('officerType').value;
            const dropdown = document.getElementById('officerDropdown');
            
            // Reset dropdown
            dropdown.innerHTML = '<option value="">-- Loading... --</option>';
            dropdown.disabled = true;
            
            // Reset search
            document.getElementById('officerSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            if (!officerType) {
                dropdown.innerHTML = '<option value="">-- Select officer type first --</option>';
                // Reload vote centres without filter
                loadVoteCentres();
                return;
            }
            
            // Reload vote centres based on selected officer type
            loadVoteCentres();
            
            setLoading(true);
            allOfficers = [];
            
            try {
                let tableName, idField, nameField;
                
                if (officerType === 'presiding') {
                    tableName = 'presiding_list';
                    idField = 'presiding_iid';
                    nameField = 'presiding_name';
                } else if (officerType === 'ass_presiding') {
                    tableName = 'ass_presiding_list';
                    idField = 'ass_presiding_iid';
                    nameField = 'ass_presiding_name';
                } else if (officerType === 'polling') {
                    tableName = 'polling_list';
                    idField = 'polling_iid';
                    nameField = 'polling_name';
                }
                
                // Fetch all officers of this type (paginated)
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let allData = [];
                
                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from(tableName)
                        .select('*')
                        .order(idField, { ascending: true })
                        .range(from, from + CHUNK - 1);
                    
                    if (error) throw error;
                    
                    const chunk = data || [];
                    allData.push(...chunk);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allData.length >= MAX_FETCH) break;
                }
                
                console.log(`Loaded ${allData.length} ${officerType} officers`);
                
                // Fetch assigned officers from request_table for this type
                let assignedOfficerIds = new Set();
                from = 0;
                let assignedData = [];
                
                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('request_table')
                        .select('officer_table_iid, officer_table_name')
                        .range(from, from + CHUNK - 1);
                    
                    if (error) throw error;
                    
                    const chunk = data || [];
                    assignedData.push(...chunk);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (assignedData.length >= MAX_FETCH) break;
                }
                
                // Create a Set of assigned officer IDs for this type only (convert to string)
                assignedData.forEach(record => {
                    if (record.officer_table_iid && record.officer_table_name === officerType) {
                        assignedOfficerIds.add(String(record.officer_table_iid));
                    }
                });
                
                console.log(`Found ${assignedOfficerIds.size} assigned ${officerType} officers`);
                
                // Store officers with unified structure, filtering out assigned ones
                allOfficers = allData
                    .filter(off => !assignedOfficerIds.has(String(off[idField])))
                    .map(off => ({
                        ...off,
                        table: tableName,
                        iid: off[idField],
                        name: off[nameField],
                        mobile: off.mobile_number || '',
                        type: officerType
                    }));
                
                console.log(`Available unassigned officers: ${allOfficers.length}`);
                
                // Populate dropdown
                let options = '<option value="">-- Select Officer --</option>';
                allOfficers.forEach((off, idx) => {
                    const displayText = `${off.iid} - ${off.name}`;
                    options += `<option value="${idx}">${displayText}</option>`;
                });
                
                dropdown.innerHTML = options;
                dropdown.disabled = false;
                
            } catch (error) {
                console.error('Error loading officers:', error);
                showStatus('Error loading officers: ' + error.message, 'error');
                dropdown.innerHTML = '<option value="">-- Error loading --</option>';
            } finally {
                setLoading(false);
            }
        }

        // Select officer from dropdown
        function selectOfficerFromDropdown() {
            const dropdown = document.getElementById('officerDropdown');
            const selectedIndex = dropdown.value;
            
            if (!selectedIndex || selectedIndex === '') {
                return;
            }
            
            const officer = allOfficers[parseInt(selectedIndex)];
            if (!officer) return;
            
            selectedOfficer = officer;
            
            document.getElementById('officerSelect').value = officer.iid;
            document.getElementById('officerName').value = officer.name || '';
            document.getElementById('requestComment').value = '';
            document.getElementById('requestComment').focus();
            
            // Update side panel summary
            const box = document.getElementById('selectedOfficerBox');
            if (box) {
                document.getElementById('selName').textContent = officer.name || '-';
                document.getElementById('selType').textContent = getOfficerTypeLabel(officer.type) || '';
                document.getElementById('selContact').textContent = officer.mobile ? ('Mobile: ' + officer.mobile) : '';
                box.style.display = 'block';
            }
        }

        // Select officer from search results
        function selectOfficer(officerId) {
            const officer = allOfficers.find(item => String(item.id) === String(officerId));
            if (!officer) return;

            selectedOfficer = officer;

            document.getElementById('officerSelect').value = officer.id;
            document.getElementById('officerName').value = officer.name;
            document.getElementById('officerSearch').value = officer.name;
            document.getElementById('requestComment').value = '';
            document.getElementById('requestComment').focus();
            document.getElementById('searchResults').style.display = 'none';

            const box = document.getElementById('selectedOfficerBox');
            if (box) {
                document.getElementById('selName').textContent = officer.name || '-';
                document.getElementById('selType').textContent = getOfficerTypeLabel(officer.type || officer.table) || '';
                document.getElementById('selContact').textContent = officer.mobile ? ('Mobile: ' + officer.mobile) : '';
                box.style.display = 'block';
            }
        }

        // Load officer details when selected (kept for compatibility)
        function loadOfficerDetails() {
            // This function is now handled by selectOfficer
        }

        // Load vote centres
        async function loadVoteCentres() {
            setLoading(true);
            
            try {
                // Get selected officer type
                const officerType = document.getElementById('officerType').value;
                
                // Fetch all data with pagination
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let allData = [];

                console.log('üìä Loading vote centres...');

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('vote_centre')
                        .select('*')
                        .order('vote_centre_code', { ascending: true })
                        .range(from, from + CHUNK - 1);

                    if (error) throw error;

                    const chunk = data || [];
                    allData.push(...chunk);
                    
                    console.log(`   Loaded chunk: ${chunk.length} rows, total: ${allData.length}`);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allData.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Total ${allData.length} vote centres loaded`);

                // Fetch request_table to count assigned officers
                let allAssignments = [];
                from = 0;
                
                console.log('üìä Loading request_table assignments...');
                
                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('request_table')
                        .select('*')
                        .range(from, from + CHUNK - 1);

                    if (error) {
                        console.warn('‚ö†Ô∏è Error loading request_table:', error.message || error);
                        break;
                    }

                    const chunk = data || [];
                    allAssignments.push(...chunk);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allAssignments.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Loaded ${allAssignments.length} request_table assignments`);

                // Count assigned officers per centre per type
                const assignmentCounts = {};
                allAssignments.forEach(assignment => {
                    const centreId = assignment.vote_centre_iid;
                    const type = assignment.officer_table_name; // presiding, ass_presiding, polling
                    
                    if (!assignmentCounts[centreId]) {
                        assignmentCounts[centreId] = {
                            presiding: 0,
                            ass_presiding: 0,
                            polling: 0
                        };
                    }
                    
                    if (assignmentCounts[centreId][type] !== undefined) {
                        assignmentCounts[centreId][type]++;
                    }
                });

                voteCentreData = {};
                let options = '<option value="">-- Select --</option>'; 
                let availableCount = 0;
                
                allData.forEach(centre => {
                    const id = centre.vote_centre_iid;
                    voteCentreData[id] = centre;
                    
                    // Calculate required slots based on officer type
                    let requiredSlots = 0;
                    const voterTotal = parseFloat(centre.voter_both_total) || 0;
                    
                    if (officerType === 'presiding') {
                        requiredSlots = 1; // 1 presiding per centre
                    } else if (officerType === 'ass_presiding') {
                        requiredSlots = Math.ceil(voterTotal / 2); // voter_both_total / 2
                    } else if (officerType === 'polling') {
                        requiredSlots = Math.ceil(voterTotal); // voter_both_total
                    }
                    
                    // Get current assigned count
                    const assignedCount = assignmentCounts[id]?.[officerType] || 0;
                    
                    // Only show centres with available slots
                    if (!officerType || assignedCount < requiredSlots) {
                        options += `<option value="${id}">${centre.vote_centre_code} - ${centre.vote_centre_name || ''} (${assignedCount}/${requiredSlots})</option>`;
                        availableCount++;
                    }
                });

                console.log(`‚úÖ ${availableCount} centres available for ${officerType || 'all'}`);

                document.getElementById('voteCentreSelect').innerHTML = options;
                
            } catch (error) {
                console.error('Error loading vote centres:', error);
                showStatus('‚ùå Failed to load centres', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Load centre details when selected
        function loadCentreDetails() {
            const centreId = document.getElementById('voteCentreSelect').value;
            
            if (!centreId || !voteCentreData[centreId]) {
                document.getElementById('voteCentreCode').value = '';
                document.getElementById('voteCentreName').value = '';
                return;
            }

            const centre = voteCentreData[centreId];
            document.getElementById('voteCentreCode').value = centre.vote_centre_code || '';
            document.getElementById('voteCentreName').value = centre.vote_centre_name || '';
        }

        // Validation: Check if officer already exists
        async function checkOfficerExists(officerTableName, officerTableIid, excludeRequestId = null) {
            try {
                let query = window.supabaseClient
                    .from('request_table')
                    .select('request_id, officer_name, vote_centre_code, vote_centre_name')
                    .eq('officer_table_name', officerTableName)
                    .eq('officer_table_iid', officerTableIid);

                if (excludeRequestId) {
                    query = query.neq('request_id', excludeRequestId);
                }

                const { data, error } = await query;
                if (error) throw error;
                
                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('Error checking officer:', error);
                return null;
            }
        }

        // Validation: Check centre capacity limits
        async function checkCentreCapacity(centreId, officerType, excludeRequestId = null) {
            try {
                // Get centre details for limits
                const centre = voteCentreData[centreId];
                if (!centre) return { allowed: false, message: 'Centre data not found' };

                const voterBothTotal = parseFloat(centre.voter_both_total) || 0;
                
                // Define limits
                const limits = {
                    'presiding': 1,
                    'ass_presiding': Math.ceil(voterBothTotal * 2),
                    'polling': Math.ceil(voterBothTotal * 4)
                };

                // Count existing entries
                let query = window.supabaseClient
                    .from('request_table')
                    .select('request_id', { count: 'exact', head: true })
                    .eq('vote_centre_iid', centreId)
                    .eq('officer_table_name', officerType);

                if (excludeRequestId) {
                    query = query.neq('request_id', excludeRequestId);
                }

                const { count, error } = await query;
                if (error) throw error;

                const currentCount = count || 0;
                const limit = limits[officerType] || 0;

                if (currentCount >= limit) {
                    const labels = {
                        'presiding': 'Presiding',
                        'ass_presiding': 'Ass. Presiding',
                        'polling': 'Polling'
                    };
                    return {
                        allowed: false,
                        message: `‚ö†Ô∏è Limit reached for ${labels[officerType]} at this centre (max: ${limit}, current: ${currentCount})`
                    }; 
                }

                return { allowed: true };
            } catch (error) {
                console.error('Error checking capacity:', error);
                return { allowed: false, message: 'Error checking capacity' }; 
            }
        }

        // Handle form submission
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('requestId').value;
            const officerId = document.getElementById('officerSelect').value;
            const officerName = document.getElementById('officerName').value;
            const centreId = document.getElementById('voteCentreSelect').value;
            const centreCode = document.getElementById('voteCentreCode').value;
            const centreName = document.getElementById('voteCentreName').value;
            const requestComment = document.getElementById('requestComment').value.trim();

            if (!officerId || !centreId || !selectedOfficer || !selectedOfficer.type) {
                showStatus('‚ö†Ô∏è Please select an officer and fill all required fields', 'error');
                return;
            }

            if (!requestComment) {
                showStatus('‚ö†Ô∏è Please fill the request/comment box', 'error');
                document.getElementById('requestComment').focus();
                return;
            }

            setLoading(true);

            try {
                // Validation 1: Check if officer already exists (for new entries only)
                if (!isEditMode || !requestId) {
                    const existingOfficer = await checkOfficerExists(selectedOfficer.type, officerId);
                    if (existingOfficer) {
                        setLoading(false);
                        const message = `‚ö†Ô∏è Warning!\n\nThis officer is already assigned:\n\nüìç Centre Code: ${existingOfficer.vote_centre_code}\nüìç Centre Name: ${existingOfficer.vote_centre_name}\n\nThe same officer cannot be assigned twice.`;
                        alert(message);
                        showStatus(`‚ö†Ô∏è This officer is already assigned to "${existingOfficer.vote_centre_code} - ${existingOfficer.vote_centre_name}"`, 'error');
                        return; 
                    }
                }

                // Validation 2: Check centre capacity
                const capacityCheck = await checkCentreCapacity(centreId, selectedOfficer.type, requestId);
                if (!capacityCheck.allowed) {
                    setLoading(false);
                    alert(capacityCheck.message);
                    showStatus(capacityCheck.message, 'error');
                    return;
                }

            } catch (validationError) {
                setLoading(false);
                console.error('Validation error:', validationError);
                showStatus('‚ö†Ô∏è Error during validation', 'error');
                return;
            }

            // If all validations pass, proceed with save

            try {
                const dataToSave = {
                    officer_name: officerName,
                    officer_table_name: selectedOfficer.type,
                    officer_table_iid: officerId,
                    vote_centre_iid: centreId,
                    vote_centre_code: centreCode,
                    vote_centre_name: centreName,
                    request_comment: requestComment
                };

                if (isEditMode && requestId) {
                    // Update existing record
                    const { error } = await window.supabaseClient
                        .from('request_table')
                        .update(dataToSave)
                        .eq('request_id', requestId);

                    if (error) throw error;
                    showStatus('‚úÖ Updated successfully', 'success');
                    // Refresh only the saved records table; keep the Add form intact
                    loadTableData();
                } else {
                    // Insert new record
                    const { error } = await window.supabaseClient
                        .from('request_table')
                        .insert([dataToSave]);

                    if (error) throw error;
                    showStatus('‚úÖ Saved successfully', 'success');
                    // Refresh only the saved records table; keep the Add form intact
                    loadTableData();
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showStatus('‚ùå Error saving: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('assignmentForm').reset();
            document.getElementById('requestId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Entry';
            document.getElementById('submitBtnText').textContent = 'üíæ Save';
            document.getElementById('officerType').value = '';
            document.getElementById('officerDropdown').innerHTML = '<option value="">-- Select officer type first --</option>';
            document.getElementById('officerDropdown').disabled = false;
            document.getElementById('officerSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('requestComment').value = '';
            searchResultsData = [];
            allOfficers = [];
            selectedOfficer = null;
            isEditMode = false;

            // Clear side panel
            const box = document.getElementById('selectedOfficerBox');
            if (box) {
                document.getElementById('selName').textContent = '-';
                document.getElementById('selType').textContent = '';
                document.getElementById('selContact').textContent = '';
                box.style.display = 'none';
            }
        }

        function focusComment() {
            const c = document.getElementById('requestComment');
            if (c) c.focus();
        }

        function resetSelection() {
            selectedOfficer = null;
            document.getElementById('officerSelect').value = '';
            document.getElementById('officerName').value = '';
            const box = document.getElementById('selectedOfficerBox');
            if (box) {
                document.getElementById('selName').textContent = '-';
                document.getElementById('selType').textContent = '';
                document.getElementById('selContact').textContent = '';
                box.style.display = 'none';
            }
        }

        // Storage for assignment status
        let assignedCentreMap = { presiding: new Map(), ass_presiding: new Map(), polling: new Map() };

        // Fetch officer details for records
        async function fetchOfficerDetailsForRecords(records) {
            const presidingIds = [];
            const assPresidingIds = [];
            const pollingIds = [];

            records.forEach(row => {
                if (row.officer_table_name === 'presiding') presidingIds.push(row.officer_table_iid);
                else if (row.officer_table_name === 'ass_presiding') assPresidingIds.push(row.officer_table_iid);
                else if (row.officer_table_name === 'polling') pollingIds.push(row.officer_table_iid);
            });

            try {
                // Fetch presiding details
                if (presidingIds.length > 0) {
                    const { data, error } = await window.supabaseClient
                        .from('presiding_list')
                        .select('presiding_iid, own_discrict, address, previous_election, date_of_birth')
                        .in('presiding_iid', presidingIds);
                    if (!error && data) {
                        data.forEach(item => {
                            const record = records.find(r => r.officer_table_name === 'presiding' && String(r.officer_table_iid) === String(item.presiding_iid));
                            if (record) record.officer_details = item;
                        });
                    }
                }

                // Fetch ass_presiding details
                if (assPresidingIds.length > 0) {
                    const { data, error } = await window.supabaseClient
                        .from('ass_presiding_list')
                        .select('ass_presiding_iid, own_discrict, address, previous_election, date_of_birth')
                        .in('ass_presiding_iid', assPresidingIds);
                    if (!error && data) {
                        data.forEach(item => {
                            const record = records.find(r => r.officer_table_name === 'ass_presiding' && String(r.officer_table_iid) === String(item.ass_presiding_iid));
                            if (record) record.officer_details = item;
                        });
                    }
                }

                // Fetch polling details
                if (pollingIds.length > 0) {
                    const { data, error } = await window.supabaseClient
                        .from('polling_list')
                        .select('polling_iid, own_discrict, address, previous_election, date_of_birth')
                        .in('polling_iid', pollingIds);
                    if (!error && data) {
                        data.forEach(item => {
                            const record = records.find(r => r.officer_table_name === 'polling' && String(r.officer_table_iid) === String(item.polling_iid));
                            if (record) record.officer_details = item;
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching officer details:', error);
            }
        }

        // Fetch assignment status from centre_assignments (paginated)
        async function fetchAssignmentStatus() {
            try {
                console.log('üìä Loading centre_assignments...');
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                const allAssignments = [];

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('centre_assignments')
                        .select('assignment_id, officer_type, officer_iid, vote_centre_iid, vote_centre_code')
                        .range(from, from + CHUNK - 1);

                    if (error) {
                        console.warn('‚ö†Ô∏è Error loading centre_assignments:', error.message || error);
                        break;
                    }

                    const chunk = data || [];
                    allAssignments.push(...chunk);

                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allAssignments.length >= MAX_FETCH) break;
                }

                // Reset maps
                assignedCentreMap = { presiding: new Map(), ass_presiding: new Map(), polling: new Map() };

                allAssignments.forEach(a => {
                    const info = { vote_centre_iid: a.vote_centre_iid, vote_centre_code: a.vote_centre_code };
                    if (a.officer_type === 'presiding') assignedCentreMap.presiding.set(String(a.officer_iid), info);
                    else if (a.officer_type === 'ass_presiding') assignedCentreMap.ass_presiding.set(String(a.officer_iid), info);
                    else if (a.officer_type === 'polling') assignedCentreMap.polling.set(String(a.officer_iid), info);
                });

                console.log(`‚úÖ Loaded ${allAssignments.length} centre_assignments`);
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not fetch assignment status (non-critical):', error.message || error);
            }
        }

        // Format date helper
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('bn-BD');
            } catch (e) {
                return dateStr;
            }
        }

        // Bengali number conversion
        function toBengaliNumber(num) {
            if (num === null || num === undefined || num === '') return '';
            const bengaliDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
            return String(num).replace(/\d/g, digit => bengaliDigits[digit]);
        }

        // Format date strings to Bengali locale (returns '-' if empty)
        function formatToBengaliDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString('bn-BD');
        }

        // Load table data
        async function loadTableData() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px;">Loading...</td></tr>';
            try {
                // Fetch all data with pagination
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let allData = [];

                console.log('üìä Loading request_table data...');

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('request_table')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .range(from, from + CHUNK - 1);

                    if (error) throw error;

                    const chunk = data || [];
                    allData.push(...chunk);
                    
                    console.log(`   Loaded chunk: ${chunk.length} rows, total: ${allData.length}`);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allData.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Total ${allData.length} records loaded from request_table`);

                // Store all data for filtering
                allTableData = allData;

                // Fetch officer details for all records
                await fetchOfficerDetailsForRecords(allTableData);

                // Fetch assignment status from centre_assignments_table
                await fetchAssignmentStatus();

                // Render table with current filter
                renderTableData();

            } catch (error) {
                console.error('Error loading table data:', error);
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px; color: red;">Failed to load</td></tr>'; 
            }
        }

        // Update sort icons
        function updateSortIcons() {
            const cols = ['officer_table_iid', 'vote_centre_code'];
            cols.forEach(col => {
                const icon = document.getElementById(`sortIcon_${col}`);
                if (!icon) return;
                if (col === currentSortColumn) {
                    icon.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
                } else {
                    icon.textContent = '‚áÖ';
                }
            });
        }

        // Sort toggler
        function sortByColumn(col) {
            console.log('Sorting by', col, 'current:', currentSortColumn, currentSortDirection);
            if (currentSortColumn === col) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = col;
                currentSortDirection = 'asc';
            }
            renderTableData();
            updateSortIcons();
        }

        // Render table data based on current filter and sort
        function renderTableData() {
            const tbody = document.getElementById('dataTableBody');

            // Filter data based on current filter type
            let filteredData = allTableData;
            if (currentFilterType !== 'all') {
                filteredData = allTableData.filter(row => row.officer_table_name === currentFilterType);
            }

            if (!filteredData || filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px;">No records found</td></tr>'; 
                updateSortIcons();
                return;
            }

            // Apply sorting if active
            let renderData = filteredData.slice();
            if (currentSortColumn) {
                renderData.sort((a, b) => {
                    const ac = a[currentSortColumn];
                    const bc = b[currentSortColumn];

                    // Numeric compare for Off Sl
                    if (currentSortColumn === 'officer_table_iid') {
                        const na = Number(ac) || 0;
                        const nb = Number(bc) || 0;
                        return currentSortDirection === 'asc' ? na - nb : nb - na;
                    }

                    // Natural compare for vote_centre_code: prefer leading numbers when present
                    if (currentSortColumn === 'vote_centre_code') {
                        const aMatch = (ac || '').toString().match(/^(\d+)/);
                        const bMatch = (bc || '').toString().match(/^(\d+)/);
                        if (aMatch && bMatch) {
                            const na = Number(aMatch[1]);
                            const nb = Number(bMatch[1]);
                            if (na !== nb) return currentSortDirection === 'asc' ? na - nb : nb - na;
                        }
                        const sa = (ac || '').toString().toLowerCase();
                        const sb = (bc || '').toString().toLowerCase();
                        if (sa < sb) return currentSortDirection === 'asc' ? -1 : 1;
                        if (sa > sb) return currentSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    }

                    const sa = (ac || '').toString().toLowerCase();
                    const sb = (bc || '').toString().toLowerCase();
                    if (sa < sb) return currentSortDirection === 'asc' ? -1 : 1;
                    if (sa > sb) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            let html = '';
            renderData.forEach((row, index) => {
                const date = new Date(row.created_at).toLocaleDateString('bn-BD');
                const officerType = row.officer_table_name || '';
                const badgeClass = officerType === 'presiding' ? 'presiding' : 
                                   officerType === 'ass_presiding' ? 'ass-presiding' : 'polling';
                
                // Check if assigned centre matches request centre
                let matched = false;
                try {
                    const assignedMap = assignedCentreMap[officerType] || new Map();
                    const assigned = assignedMap.get(String(row.officer_table_iid));
                    if (assigned) {
                        if (assigned.vote_centre_iid && row.vote_centre_iid && String(assigned.vote_centre_iid) === String(row.vote_centre_iid)) matched = true;
                        else if (assigned.vote_centre_code && row.vote_centre_code && String(assigned.vote_centre_code) === String(row.vote_centre_code)) matched = true;
                    }
                } catch (e) {
                    console.error('Error comparing assignment centres:', e);
                }

                const details = row.officer_details || {};
                const ownDistrict = toBengaliNumber(details.own_discrict || '-');
                const address = toBengaliNumber(details.address || '-');
                const previousElection = toBengaliNumber(details.previous_election || '-');
                const requestComment = toBengaliNumber(row.request_comment || '');
                const dateOfBirth = toBengaliNumber(formatToBengaliDate(details.date_of_birth || ''));
                // Lookup centre info for total voters (prefer `total_voter`)
                const centreInfo = (voteCentreData && voteCentreData[row.vote_centre_iid]) ? voteCentreData[row.vote_centre_iid] : null;
                const totalVoterRaw = centreInfo ? (centreInfo.total_voter ?? centreInfo.voter_both_total ?? centreInfo.voter_total ?? '-') : '-';
                const totalVoter = toBengaliNumber(totalVoterRaw);
                const createdDate = toBengaliNumber(formatToBengaliDate(row.created_at));
                
                html += `
                    <tr>
                        <td>${toBengaliNumber(index + 1)}</td>
                        <td>${toBengaliNumber(row.officer_name || '')}</td>
                        <td><span class="badge ${badgeClass}">${getOfficerTypeLabel(officerType)}</span></td>
                        <td>${toBengaliNumber(row.officer_table_iid || '')}</td>
                        <td>${toBengaliNumber(row.vote_centre_code || '')}</td>
                        <td>${toBengaliNumber(row.vote_centre_name || '')}</td>
                        <td>${ownDistrict}</td>
                        <td>${address}</td>
                        <td>${previousElection}</td>
                        <td>${dateOfBirth}</td>
                        <td>${totalVoter}</td>
                        <td>${requestComment}</td>
                        <td>${createdDate}</td>
                        <td style="text-align:center"><span class="matched-tick">${matched ? '‚úî' : ''}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary btn-sm" onclick="editRecord(${row.request_id})">
                                    Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRecord(${row.request_id})">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            updateSortIcons();
        }

        // Filter by officer type
        function filterByType(type) {
            currentFilterType = type;

            // Update button styles
            const buttons = ['filterAll', 'filterPresiding', 'filterAssPresiding', 'filterPolling'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.background = '#cbd5e1';
                    btn.style.opacity = '0.8';
                }
            });

            // Highlight active filter button
            let activeButtonId = 'filterAll';
            if (type === 'presiding') activeButtonId = 'filterPresiding';
            else if (type === 'ass_presiding') activeButtonId = 'filterAssPresiding';
            else if (type === 'polling') activeButtonId = 'filterPolling';

            const activeBtn = document.getElementById(activeButtonId);
            if (activeBtn) {
                activeBtn.style.background = '#667eea';
                activeBtn.style.opacity = '1';
            }

            // Re-render table with filter
            renderTableData();
        }

        // Edit record
        async function editRecord(requestId) {
            setLoading(true);

            try {
                const { data, error } = await window.supabaseClient
                    .from('request_table')
                    .select('*')
                    .eq('request_id', requestId)
                    .single();

                if (error) throw error;

                // Set form values
                document.getElementById('requestId').value = data.request_id;

                // Set officer and centre
                document.getElementById('officerSelect').value = data.officer_table_iid;
                document.getElementById('officerName').value = data.officer_name;
                document.getElementById('officerSearch').value = data.officer_name;
                document.getElementById('voteCentreSelect').value = data.vote_centre_iid;
                document.getElementById('voteCentreCode').value = data.vote_centre_code;
                document.getElementById('voteCentreName').value = data.vote_centre_name;

                // set selectedOfficer for compatibility (short type like 'presiding')
                selectedOfficer = { iid: data.officer_table_iid, name: data.officer_name, type: data.officer_table_name };

                document.getElementById('requestComment').value = data.request_comment || '';
                document.getElementById('commentGroup').style.display = 'block';

                // Update form title and button
                document.getElementById('formTitle').textContent = 'Edit Entry';
                document.getElementById('submitBtnText').textContent = '‚úÖ Update';
                isEditMode = true;

                // Scroll to form
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading record:', error);
                showStatus('‚ùå Failed to load record', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Delete record
        async function deleteRecord(requestId) {
            if (!confirm('Are you sure you want to delete this record?')) {
                return;
            }

            setLoading(true);

            try {
                const { error } = await window.supabaseClient
                    .from('request_table')
                    .delete()
                    .eq('request_id', requestId);

                if (error) throw error;

                showStatus('‚úÖ Deleted successfully', 'success');
                loadTableData();

            } catch (error) {
                console.error('Error deleting record:', error);
                showStatus('‚ùå Error deleting: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Print table only
        function printTable() {
            window.print();
        }
    </script>
</body>
</html>
