<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶®‡¶ø‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nikosh', 'SolaimanLipi', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: bold;
            color: #333;
        }

        .search-result-id {
            color: #666;
            font-size: 14px;
        }

        .selected-officer {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
            display: none;
        }

        .selected-officer strong {
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó≥Ô∏è ‡¶®‡¶ø‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡¶ø‡¶§‡ßç‡¶¨ ‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó/‡¶§‡¶¶‡¶¨‡¶ø‡¶∞</h1>
        
        <div class="status" id="status"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <h2 id="formTitle">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            
            <form id="assignmentForm">
                <input type="hidden" id="requestId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="officerSearch">‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/ID ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="officerSearch" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/ID ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="flex: 1;" onkeyup="handleSearchKeyup(event)">
                            <button type="button" class="btn btn-primary" onclick="searchOfficers()" style="padding: 12px 20px;">üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
                        </div>
                        <input type="hidden" id="officerSelect" required>
                        <div id="searchResults" style="max-height: 260px; overflow-y: auto; margin-top: 10px; border: 2px solid #ddd; border-radius: 8px; display: none; background: white;"></div>
                    </div>

                    <div class="form-group">
                        <label for="officerName">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
                        <input type="text" id="officerName" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="voteCentreSelect">‡¶≠‡ßã‡¶ü ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ *</label>
                        <select id="voteCentreSelect" required onchange="loadCentreDetails()">
                            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="voteCentreCode">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ï‡ßã‡¶°</label>
                        <input type="text" id="voteCentreCode" readonly>
                    </div>

                    <div class="form-group">
                        <label for="voteCentreName">‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="voteCentreName" readonly>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                        <span id="submitBtnText">üíæ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    </button>
                    <button type="button" class="btn btn-warning" onclick="resetForm()">
                        üîÑ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
                    </button>
                </div>
            </form>
        </div>

        <!-- Table Section -->
        <div class="table-container">
            <h2 style="margin-bottom: 15px; color: #667eea;">üìã ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï</th>
                        <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                        <th>‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶ß‡¶∞‡¶®</th>
                        <th>‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ï‡ßã‡¶°</th>
                        <th>‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                        <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                        <th>‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadVoteCentres();
            loadTableData();
        });

        let officerData = {};
        let voteCentreData = {};
        let isEditMode = false;
        let allOfficers = [];
        let searchResultsData = [];
        let selectedOfficer = null;

        // Helper function to show status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Show/hide loading
        function setLoading(isLoading) {
            const loading = document.getElementById('loading');
            loading.style.display = isLoading ? 'block' : 'none';
        }

        // Get officer type label in Bengali
        function getOfficerTypeLabel(type) {
            const labels = {
                'presiding': '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç',
                'ass_presiding': '‡¶∏‡¶π-‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç',
                'polling': '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç'
            };
            return labels[type] || type;
        }



        // Search officers across all tables (server-side, like postal_ballet)
        async function searchOfficers() {
            const searchTerm = document.getElementById('officerSearch').value.trim();
            const resultsContainer = document.getElementById('searchResults');

            if (!searchTerm) {
                resultsContainer.style.display = 'none';
                showStatus('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§', 'error');
                return;
            }

            setLoading(true);
            searchResultsData = [];

            try {
                // presiding
                const { data: presidingData, error: presidingError } = await window.supabaseClient
                    .from('presiding_list')
                    .select('*')
                    .or(`presiding_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                if (presidingError) throw presidingError;
                if (presidingData && presidingData.length) {
                    presidingData.forEach(off => {
                        searchResultsData.push({
                            ...off,
                            table: 'presiding_list',
                            iid: off.presiding_iid,
                            name: off.presiding_name,
                            mobile: off.mobile_number || '',
                            designation: off.presiding_designation || ''
                        });
                    });
                }

                // ass_presiding
                const { data: assData, error: assError } = await window.supabaseClient
                    .from('ass_presiding_list')
                    .select('*')
                    .or(`ass_presiding_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                if (assError) throw assError;
                if (assData && assData.length) {
                    assData.forEach(off => {
                        searchResultsData.push({
                            ...off,
                            table: 'ass_presiding_list',
                            iid: off.ass_presiding_iid,
                            name: off.ass_presiding_name,
                            mobile: off.mobile_number || '',
                            designation: off.ass_presiding_designation || ''
                        });
                    });
                }

                // polling
                const { data: pollData, error: pollError } = await window.supabaseClient
                    .from('polling_list')
                    .select('*')
                    .or(`polling_name.ilike.%${searchTerm}%,mobile_number.ilike.%${searchTerm}%`);
                if (pollError) throw pollError;
                if (pollData && pollData.length) {
                    pollData.forEach(off => {
                        searchResultsData.push({
                            ...off,
                            table: 'polling_list',
                            iid: off.polling_iid,
                            name: off.polling_name,
                            mobile: off.mobile_number || '',
                            designation: off.polling_designation || ''
                        });
                    });
                }

                displaySearchResults();

            } catch (error) {
                console.error('Search error:', error);
                showStatus('‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Display unified search results
        function displaySearchResults() {
            const resultsContainer = document.getElementById('searchResults');

            if (searchResultsData.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            let html = '';
            searchResultsData.slice(0,50).forEach((item, idx) => {
                html += `
                    <div class="search-result-item" onclick="selectOfficerFromResults(${idx})">
                        <div class="search-result-name">${item.name}</div>
                        <div class="search-result-id">ID: ${item.iid} | ${getOfficerTypeLabelByTable(item.table)}</div>
                    </div>
                `;
            });

            if (searchResultsData.length > 50) {
                html += '<div style="padding: 12px; text-align: center; color: #666; font-size: 14px;">‡¶Ü‡¶∞‡¶ì ' + (searchResultsData.length - 50) + ' ‡¶ú‡¶®... ‡¶Ü‡¶∞‡¶ì ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶∞‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</div>';
            }

            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        function getOfficerTypeLabelByTable(table) {
            if (table === 'presiding_list') return '‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç';
            if (table === 'ass_presiding_list') return '‡¶∏‡¶π-‡¶™‡ßç‡¶∞‡¶ø‡¶ú‡¶æ‡¶á‡¶°‡¶ø‡¶Ç';
            if (table === 'polling_list') return '‡¶™‡ßã‡¶≤‡¶ø‡¶Ç';
            return table;
        }

        // Select officer from unified results
        function selectOfficerFromResults(index) {
            const officer = searchResultsData[index];
            if (!officer) return;

            const short = (officer.table === 'presiding_list') ? 'presiding' : (officer.table === 'ass_presiding_list') ? 'ass_presiding' : (officer.table === 'polling_list') ? 'polling' : officer.table;
            officer.type = short; // short name used for saving (e.g., 'presiding')
            selectedOfficer = officer;

            document.getElementById('officerSelect').value = officer.iid;
            document.getElementById('officerName').value = officer.name || '';
            document.getElementById('officerSearch').value = officer.name || '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // Handle Enter key in search box
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchOfficers();
            }
        }

        // Select officer from search results
        function selectOfficer(officerId) {
            const officer = allOfficers.find(item => String(item.id) === String(officerId));
            if (!officer) return;

            selectedOfficer = officer;
            document.getElementById('officerSelect').value = officer.id;
            document.getElementById('officerName').value = officer.name;
            document.getElementById('officerSearch').value = officer.name;
            document.getElementById('searchResults').style.display = 'none';
        }

        // Load officer details when selected (kept for compatibility)
        function loadOfficerDetails() {
            // This function is now handled by selectOfficer
        }

        // Load vote centres
        async function loadVoteCentres() {
            setLoading(true);
            
            try {
                // Fetch all data with pagination
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let allData = [];

                console.log('üìä Loading vote centres...');

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('vote_centre')
                        .select('*')
                        .order('vote_centre_code', { ascending: true })
                        .range(from, from + CHUNK - 1);

                    if (error) throw error;

                    const chunk = data || [];
                    allData.push(...chunk);
                    
                    console.log(`   Loaded chunk: ${chunk.length} rows, total: ${allData.length}`);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allData.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Total ${allData.length} vote centres loaded`);

                voteCentreData = {};
                let options = '<option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
                
                allData.forEach(centre => {
                    const id = centre.vote_centre_iid;
                    voteCentreData[id] = centre;
                    options += `<option value="${id}">${centre.vote_centre_code} - ${centre.vote_centre_name || ''}</option>`;
                });

                document.getElementById('voteCentreSelect').innerHTML = options;
                
            } catch (error) {
                console.error('Error loading vote centres:', error);
                showStatus('‚ùå ‡¶ï‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Load centre details when selected
        function loadCentreDetails() {
            const centreId = document.getElementById('voteCentreSelect').value;
            
            if (!centreId || !voteCentreData[centreId]) {
                document.getElementById('voteCentreCode').value = '';
                document.getElementById('voteCentreName').value = '';
                return;
            }

            const centre = voteCentreData[centreId];
            document.getElementById('voteCentreCode').value = centre.vote_centre_code || '';
            document.getElementById('voteCentreName').value = centre.vote_centre_name || '';
        }

        // Handle form submission
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const requestId = document.getElementById('requestId').value;
            const officerId = document.getElementById('officerSelect').value;
            const officerName = document.getElementById('officerName').value;
            const centreId = document.getElementById('voteCentreSelect').value;
            const centreCode = document.getElementById('voteCentreCode').value;
            const centreName = document.getElementById('voteCentreName').value;

            if (!officerId || !centreId || !selectedOfficer || !selectedOfficer.type) {
                showStatus('‚ö†Ô∏è ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
                return;
            }

            setLoading(true);

            try {
                const dataToSave = {
                    officer_name: officerName,
                    officer_table_name: selectedOfficer.type,
                    officer_table_iid: officerId,
                    vote_centre_iid: centreId,
                    vote_centre_code: centreCode,
                    vote_centre_name: centreName
                };

                if (isEditMode && requestId) {
                    // Update existing record
                    const { error } = await window.supabaseClient
                        .from('request_table')
                        .update(dataToSave)
                        .eq('request_id', requestId);

                    if (error) throw error;
                    showStatus('‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                } else {
                    // Insert new record
                    const { error } = await window.supabaseClient
                        .from('request_table')
                        .insert([dataToSave]);

                    if (error) throw error;
                    showStatus('‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                }

                resetForm();
                loadTableData();

            } catch (error) {
                console.error('Error saving data:', error);
                showStatus('‚ùå ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('assignmentForm').reset();
            document.getElementById('requestId').value = '';
            document.getElementById('formTitle').textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('submitBtnText').textContent = 'üíæ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('officerSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            searchResultsData = [];
            allOfficers = [];
            selectedOfficer = null;
            isEditMode = false;
        }

        // Load table data
        async function loadTableData() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>';

            try {
                // Fetch all data with pagination
                const CHUNK = 1000;
                const MAX_FETCH = 50000;
                let from = 0;
                let allData = [];

                console.log('üìä Loading request_table data...');

                while (true) {
                    const { data, error } = await window.supabaseClient
                        .from('request_table')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .range(from, from + CHUNK - 1);

                    if (error) throw error;

                    const chunk = data || [];
                    allData.push(...chunk);
                    
                    console.log(`   Loaded chunk: ${chunk.length} rows, total: ${allData.length}`);
                    
                    if (chunk.length < CHUNK) break;
                    from += CHUNK;
                    if (allData.length >= MAX_FETCH) break;
                }

                console.log(`‚úÖ Total ${allData.length} records loaded from request_table`);

                if (!allData || allData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶®‡ßá‡¶á</td></tr>';
                    return;
                }

                let html = '';
                allData.forEach((row, index) => {
                    const date = new Date(row.created_at).toLocaleDateString('bn-BD');
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.officer_name || ''}</td>
                            <td>${getOfficerTypeLabel(row.officer_table_name)}</td>
                            <td>${row.vote_centre_code || ''}</td>
                            <td>${row.vote_centre_name || ''}</td>
                            <td>${date}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn btn-primary btn-sm" onclick="editRecord(${row.request_id})">
                                        ‚úèÔ∏è ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteRecord(${row.request_id})">
                                        üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

            } catch (error) {
                console.error('Error loading table data:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: red;">‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</td></tr>';
            }
        }

        // Edit record
        async function editRecord(requestId) {
            setLoading(true);

            try {
                const { data, error } = await window.supabaseClient
                    .from('request_table')
                    .select('*')
                    .eq('request_id', requestId)
                    .single();

                if (error) throw error;

                // Set form values
                document.getElementById('requestId').value = data.request_id;

                // Set officer and centre
                document.getElementById('officerSelect').value = data.officer_table_iid;
                document.getElementById('officerName').value = data.officer_name;
                document.getElementById('officerSearch').value = data.officer_name;
                document.getElementById('voteCentreSelect').value = data.vote_centre_iid;
                document.getElementById('voteCentreCode').value = data.vote_centre_code;
                document.getElementById('voteCentreName').value = data.vote_centre_name;

                // set selectedOfficer for compatibility (short type like 'presiding')
                selectedOfficer = { iid: data.officer_table_iid, name: data.officer_name, type: data.officer_table_name };

                // Update form title and button
                document.getElementById('formTitle').textContent = '‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
                document.getElementById('submitBtnText').textContent = '‚úÖ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
                isEditMode = true;

                // Scroll to form
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading record:', error);
                showStatus('‚ùå ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            } finally {
                setLoading(false);
            }
        }

        // Delete record
        async function deleteRecord(requestId) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                return;
            }

            setLoading(true);

            try {
                const { error } = await window.supabaseClient
                    .from('request_table')
                    .delete()
                    .eq('request_id', requestId);

                if (error) throw error;

                showStatus('‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
                loadTableData();

            } catch (error) {
                console.error('Error deleting record:', error);
                showStatus('‚ùå ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>
</html>
