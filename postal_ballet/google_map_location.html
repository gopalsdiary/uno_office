<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Map Location - Vote Centres</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            padding: 20px;
        }

        /* Card styles for mobile-friendly layout */
        .card-grid {
            display: grid;
            /* Single-column layout so each card occupies its own row on desktop */
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 20px;
            list-style: none;
            padding: 0;
            align-items: stretch;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(15,23,42,0.04);
            /* stronger, multi-layered shadow for consistent elevation */
            box-shadow: 0 8px 24px rgba(15,23,42,0.08), 0 2px 6px rgba(15,23,42,0.04);
            display: flex;
            flex-direction: column;
            transition: transform 160ms ease, box-shadow 160ms ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 18px 44px rgba(15,23,42,0.14), 0 6px 18px rgba(15,23,42,0.08);
        }

        .card-title {
            font-size: 1.05rem;
            margin: 0 0 6px 0;
            color: #1f2937;
        }

        .card-meta {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 12px;
            line-height: 1.35;
        }

        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 8px;
            justify-content: flex-end; /* align actions to the right */
        }

        .map-link {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #ff7a00; /* orange */
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 6px 12px rgba(255,122,0,0.16);
        }

        .map-link:hover { background-color: #e05b00; }

        /* Filter row styles */
        .filter-row {
            display: none; /* shown after data loads */
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .area-select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
            background: white;
            font-weight: 600;
        }

        .area-badge {
            color: #6b7280;
            font-weight: 600;
            margin-left: 8px;
        }

        @media (max-width: 480px) {
            .filter-row { flex-direction: column; align-items: stretch; gap: 8px; }
            .area-badge { margin-left: 0; }
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background: #ffe6e6;
            border-radius: 4px;
            margin: 20px 0;
        }

        @media (max-width: 480px) {
            .container { padding: 12px; }
            .card-grid { gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Vote Centre Locations</h1>
    <div id="status" class="loading">Loading data...</div>
    <div class="filter-row" style="display:none;">
        <label for="areaFilter" style="font-weight:600; margin-right:8px;">Filter by Area:</label>
        <select id="areaFilter" class="area-select">
            <option value="">All areas</option>
        </select>
        <span id="resultCount" class="area-badge"></span>
    </div>
    <div id="table-container"></div>
</div>

<script>
    // Supabase Configuration from instructions
    const SUPABASE_URL = window.SUPABASE_URL || 'https://tschsyozvlneslqylqii.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzY2hzeW96dmxuZXNscXlscWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MzcyNjgsImV4cCI6MjA4MjMxMzI2OH0.7kfq7K-jbFmgnin2zkLJf7GIulGXvfQzBkzjs0iAO14';
    
    // Initialize Supabase client
    const supabaseClient = window.supabaseClient || (window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));
    let voteData = []; // holds fetched vote centre records for filtering

    // Function to fetch data and render table
    async function loadVoteCentres() {
        const statusDiv = document.getElementById('status');
        const tableContainer = document.getElementById('table-container');

        try {
            // Fetch relevant columns from public.vote_centre
            const { data, error } = await supabaseClient
                .from('vote_centre')
                .select('vote_centre_iid, vote_centre_code, vote_centre_name, vote_centre_location, vote_centre_area, location_url')
                .order('vote_centre_code', { ascending: true });

            if (error) {
                throw error;
            }

            if (!data || data.length === 0) {
                statusDiv.innerHTML = 'No vote centres found.';
                return;
            }

            // Store data and initialize UI
            voteData = data;
            populateAreaFilter(data);
            renderCards(data);
            // show filter row
            const filterRow = document.querySelector('.filter-row');
            if (filterRow) filterRow.style.display = 'flex';
            statusDiv.style.display = 'none';

        } catch (err) {
            console.error('Error fetching data:', err);
            statusDiv.className = 'error';
            statusDiv.innerHTML = `Error loading data: ${err.message}`;
        }
    }

    // Populate area dropdown with unique areas
    function populateAreaFilter(data) {
        const sel = document.getElementById('areaFilter');
        if (!sel) return;
        // compute unique areas (use 'Unknown' for empty)
        const areas = Array.from(new Set(data.map(d => (d.vote_centre_area && d.vote_centre_area.toString().trim()) ? d.vote_centre_area.toString().trim() : 'Unknown')));
        areas.sort((a,b) => a.localeCompare(b));
        // clear existing (except All areas)
        sel.innerHTML = '<option value="">All areas</option>';
        areas.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a;
            opt.textContent = a === 'Unknown' ? 'Unknown' : a;
            sel.appendChild(opt);
        });
        sel.addEventListener('change', function() {
            renderCards(voteData, this.value);
        });
    }

    // Render cards, optionally filter by area
    function renderCards(data, areaFilter = '') {
        const tableContainer = document.getElementById('table-container');
        const resultCount = document.getElementById('resultCount');
        if (!tableContainer) return;
        const filtered = data.filter(d => {
            const area = (d.vote_centre_area && d.vote_centre_area.toString().trim()) ? d.vote_centre_area.toString().trim() : 'Unknown';
            return !areaFilter || areaFilter === '' ? true : area === areaFilter;
        });
        let html = '<div class="card-grid">';
        filtered.forEach(centre => {
            const code = centre.vote_centre_code || '';
            const name = centre.vote_centre_name || '';
            const location = centre.vote_centre_location || '';
            const area = centre.vote_centre_area || '';
            const locationUrl = centre.location_url || '';
            const locationParts = [name, location, area].filter(part => part && part.trim() !== '');
            const query = locationParts.join(', ');
            const encodedQuery = encodeURIComponent(query);
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
            const finalMapHref = locationUrl && locationUrl.trim() ? locationUrl : mapUrl;
            html += `<article class="card">\n                        <div>\n                            <h2 class="card-title">${name || '-'} </h2>\n                            <div class="card-meta"><strong>Code:</strong> ${code || '-'} &nbsp; <strong>Location:</strong> ${location || '-'} &nbsp; <strong>Area:</strong> ${area || '-'}</div>\n                        </div>\n                        <div class="card-actions">\n                            <a href="${finalMapHref}" target="_blank" class="map-link">Open Map</a>\n                        </div>\n                    </article>`;
        });
        html += '</div>';
        tableContainer.innerHTML = html;
        if (resultCount) resultCount.textContent = `${filtered.length} centre(s)`;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadVoteCentres);
</script>

</body>
</html>
