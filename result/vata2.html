<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ভোটগ্রহণকারী কর্মকর্তাদের ভাতা প্রদানের হিসাব বিবরণী</title>
    <style>
        @font-face {
            font-family: 'NikoshBan';
            src: local('NikoshBan');
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            font-family: 'NikoshBan', 'Nikosh', sans-serif;
            font-size: 9.5pt;
        }

        .legal-page {
            width: 8.5in;
            height: 14in;
            padding: 0.4in 0.5in;
            margin: 0 auto 20px auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
            overflow: hidden;
        }

        #loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 1000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 5px;
        }

        th,
        td {
            border: 1px solid black;
            padding: 2px 4px;
            vertical-align: middle;
            line-height: 1.1;
        }

        .bg-gray {
            background-color: #f2f2f2 !important;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .fw-bold {
            font-weight: bold;
        }

        .summary-table {
            border-collapse: collapse;
            width: 100%;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid black !important;
            padding: 4px;
            font-size: 10pt;
        }

        .note-cell {
            font-size: 16pt !important;
            font-weight: bold;
        }

        @page {
            size: 14in 8.5in;
            margin: 0.1in;
        }

        @media print {

            body,
            html {
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }

            .legal-page {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0.1in !important;
                width: 13.8in !important;
                height: 8.2in !important;
                page-break-after: always !important;
                position: relative;
                overflow: visible !important;
            }

            tr {
                page-break-inside: avoid !important;
            }

            #loading-indicator {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
</head>

<body>
    <div id="loading-indicator">উপাত্ত লোড হচ্ছে...</div>
    <div id="app"></div>

    <script id="summary-template" type="text/template">
        <div class="legal-page summary-page" style="height: auto; min-height: 8.5in; width: 14in; height: auto;">
            <h2 class="text-center" style="margin-top: 0; margin-bottom: 5px;">ভোটগ্রহণকারী কর্মকর্তাদের ভাতা প্রদানের হিসাব বিবরণী</h2>
            <table width="100%" class="summary-table" style="font-size: 8pt;">
                <thead>
                    <tr class="bg-gray text-center fw-bold">
                        <td rowspan="2" width="3%">কেন্দ্র কোড</td>
                        <td rowspan="2" width="10%">প্রিজাইডিং অফিসারের নাম</td>
                        <td rowspan="2" width="15%">ভোটকেন্দ্রের নাম</td>
                        <td rowspan="2" width="2%">কক্ষ</td>
                        <td rowspan="2" width="8%">মোট প্রদত্ত টাকা</td>
                        {{header_denoms_group}}
                        <td rowspan="2" width="8%">স্বাক্ষর</td>
                    </tr>
                    <tr class="bg-gray text-center fw-bold">
                        {{header_denoms}}
                    </tr>
                </thead>
                <tbody>
                    {{rows}}
                </tbody>
                <tfoot>
                    <tr class="fw-bold bg-gray text-center">
                        <td colspan="4" class="text-right">সর্বমোট:</td>
                        <td>{{total_net}}</td>
                        {{footer_denoms}}
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <table width="100%" class="signature-table" style="margin-top: 20px; border: none;">
                <tr valign="top" class="text-center" style="border: none;">
                    <td width="33%" style="border: none;">
                        <p style="border-top: 1px solid black; display: inline-block; width: 180px; padding-top: 5px;"><b>অফিস সহকারী/আইটি</b></p>
                    </td>
                    <td width="33%" style="border: none;">
                         <p style="border-top: 1px solid black; display: inline-block; width: 220px; padding-top: 5px;"><b>হিসাব রক্ষণ কর্মকর্তা</b></p>
                    </td>
                    <td width="33%" style="border: none;">
                        <p style="border-top: 1px solid black; display: inline-block; width: 220px; padding-top: 5px;"><b>রিটার্নিং/সহকারী রিটার্নিং অফিসার</b></p>
                    </td>
                </tr>
            </table>
        </div>
    </script>

    <script>
        const App = {
            bn: ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'],

            toBn(n) { return n === null ? '' : String(n).replace(/\d/g, d => this.bn[+d]); },
            toEn(s) { const m = { '০': '0', '১': '1', '২': '2', '৩': '3', '৪': '4', '৫': '5', '৬': '6', '৭': '7', '৮': '8', '৯': '9' }; return String(s).replace(/[০-৯]/g, x => m[x]); },

            async init() {
                try {
                    // Fetch centers and assignments separately
                    const [centersRes, assignmentsRes] = await Promise.all([
                        window.supabaseClient.from('vote_centre').select('*').limit(5000),
                        window.supabaseClient.from('centre_assignments').select('vote_centre_code, officer_name, officer_type').eq('officer_type', 'presiding').limit(5000)
                    ]);

                    if (centersRes.error) throw centersRes.error;
                    if (assignmentsRes.error) throw assignmentsRes.error;

                    const data = centersRes.data.sort((a, b) => (Number(a.vote_centre_code) || 0) - (Number(b.vote_centre_code) || 0));
                    const assignments = assignmentsRes.data;

                    const allCalculated = data.map(d => {
                        const res = this.calculate(d);
                        const presidingName = assignments.find(a => String(a.vote_centre_code) === String(d.vote_centre_code))?.officer_name || '';
                        return { d, res, presidingName };
                    });

                    // Determine active denominations (those with > 0 total)
                    const denoms = [1000, 500, 200, 100, 50, 20, 10, 5, 2, 1];
                    const activeDenoms = denoms.filter(denom =>
                        allCalculated.some(item => (item.res.notes[denom] || 0) > 0)
                    );

                    const container = document.getElementById('app');
                    let rowsHtml = '';
                    let sumNet = 0;
                    let denomTotals = {};
                    activeDenoms.forEach(d => denomTotals[d] = 0);

                    allCalculated.forEach(({ d, res, presidingName }) => {
                        sumNet += res.net;
                        activeDenoms.forEach(denom => {
                            denomTotals[denom] += (res.notes[denom] || 0);
                        });

                        let notesCols = '';
                        activeDenoms.forEach(denom => {
                            const count = res.notes[denom] || 0;
                            notesCols += `<td class="note-cell">${count > 0 ? this.toBn(count) : ''}</td>`;
                        });

                        rowsHtml += `
                            <tr class="text-center">
                                <td>${this.toBn(d.vote_centre_code)}</td>
                                <td class="text-left">${presidingName}</td>
                                <td class="text-left">${d.vote_centre_name}</td>
                                <td>${this.toBn(res.vbt)}</td>
                                <td class="fw-bold">${this.toBn(res.net.toLocaleString('bn-BD'))}</td>
                                ${notesCols}
                                <td></td>
                            </tr>
                        `;
                    });

                    let headerDenomsGroup = activeDenoms.length > 0 ? `<td colspan="${activeDenoms.length}" width="30%">নোটের বিবরণ (টি)</td>` : '';
                    let headerDenoms = activeDenoms.map(d => `<td class="note-cell">${this.toBn(d)}</td>`).join('');
                    let footerDenoms = activeDenoms.map(d => `<td class="note-cell">${denomTotals[d] > 0 ? this.toBn(denomTotals[d].toLocaleString('bn-BD')) : ''}</td>`).join('');

                    let sTmp = document.getElementById('summary-template').innerHTML;
                    sTmp = sTmp.replace('{{rows}}', rowsHtml)
                        .replace('{{header_denoms_group}}', headerDenomsGroup)
                        .replace('{{header_denoms}}', headerDenoms)
                        .replace('{{footer_denoms}}', footerDenoms)
                        .replace('{{total_net}}', this.toBn(sumNet.toLocaleString('bn-BD')));

                    const sEl = document.createElement('div');
                    sEl.innerHTML = sTmp;
                    container.appendChild(sEl.firstElementChild);

                    document.getElementById('loading-indicator').style.display = 'none';
                } catch (e) {
                    console.error(e);
                    document.getElementById('loading-indicator').textContent = "ত্রুটি ঘটেছে!";
                }
            },

            calculate(data) {
                const totalVoter = parseInt(this.toEn(data.total_voter || 0));
                const voterBothTotal = parseInt(this.toEn(data.voter_both_total)) || Math.ceil(totalVoter / 1200);
                const totalOfficer = 1 + voterBothTotal + (voterBothTotal * 2);

                const presidingTotal = 8000;
                const assistantTotal = voterBothTotal * 6000;
                const pollingTotal = (voterBothTotal * 2) * 4000;
                const honorariumTotal = presidingTotal + assistantTotal + pollingTotal;

                const travelTotal = totalOfficer * 1000;
                const bestniTotal = voterBothTotal * 1200;
                const monihariTotal = 1500;

                const grossTotal = honorariumTotal + travelTotal + bestniTotal + monihariTotal;
                const tax10 = Math.round(honorariumTotal * 0.10);
                const vatIt = Math.round(bestniTotal * 0.15);
                const monihariVat = Math.round(monihariTotal * 0.15);
                const revenue = (totalOfficer + 2) * 10;

                const totalDeduction = tax10 + vatIt + monihariVat + revenue;
                const netTotal = grossTotal - totalDeduction;

                return {
                    gross: grossTotal,
                    deduction: totalDeduction,
                    net: netTotal,
                    vbt: voterBothTotal,
                    voter: totalVoter,
                    officer: totalOfficer,
                    assistantTotal,
                    pollingTotal,
                    travelTotal,
                    bestniTotal,
                    monihariTotal,
                    tax10,
                    vatIt,
                    monihariVat,
                    revenue,
                    notes: this.getDenominations(netTotal)
                };
            },

            getDenominations(amount) {
                let remaining = amount;
                const denoms = [1000, 500, 200, 100, 50, 20, 10, 5, 2, 1];
                const result = {};

                // 1. Mandatory 12,000 taka in 500 notes (24 notes)
                if (remaining >= 12000) {
                    result[500] = 24;
                    remaining -= 12000;
                } else {
                    result[500] = 0;
                }

                // 2. Round with 1000 taka notes
                if (remaining >= 1000) {
                    result[1000] = Math.floor(remaining / 1000);
                    remaining %= 1000;
                } else {
                    result[1000] = 0;
                }

                // 3. Distribute rest with denominations
                denoms.slice(2).forEach(d => {
                    if (remaining >= d) {
                        result[d] = Math.floor(remaining / d);
                        remaining %= d;
                    } else {
                        result[d] = 0;
                    }
                });

                // Also add remaining 500s if any left after mandatory and 1000s (though unlikely with current rules)
                // Actually the rule says "rest with change", so we strictly follow the denom order.

                return result;
            }
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>