<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title></title>
	<style>
		@page {
			size: 216mm 356mm;
			/* Legal Size */
			margin: 10mm 10mm 8mm 10mm;
			/* Adjusted margins for print */
		}

		body {
			width: 216mm;
			margin: 0 auto;
			padding: 0;
			font-family: 'NikoshBAN', 'Nikosh', sans-serif;
			font-size: 11pt;
			/* Slightly smaller to ensure fit */
			color: #000;
			background: #fff;
		}

		.centre-page {
			page-break-after: always;
			height: 100%;
			/* Try to occupy full height */
			box-sizing: border-box;
		}

		.centre-page:last-child {
			page-break-after: auto;
		}

		#centre-template {
			display: none;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		td,
		th {
			border: 1px solid #000;
			padding: 3px 4px;
			/* Tight padding */
			vertical-align: middle;
			/* Better align */
			font-weight: normal;
		}

		/* Helper classes */
		.text-center {
			text-align: center;
		}

		.text-left {
			text-align: left;
		}

		.text-right {
			text-align: right;
		}

		.font-bold {
			font-weight: bold;
		}

		.candidate-sign {
			font-weight: bold;
		}

		.header-title {
			font-size: 18pt;
			font-weight: bold;
			margin-bottom: 2px;
		}

		.header-subtitle {
			font-size: 12pt;
			font-weight: bold;
			margin-bottom: 4px;
		}

		.info-table {
			border-collapse: separate;
			border-spacing: 0 8px;
		}

		.info-table td {
			border: none;
			padding: 2px;
		}

		.info-label {
			width: 25%;
			font-size: 12pt;
		}

		.info-value {
			border: 1px solid #000 !important;
			font-weight: bold;
			font-size: 13pt;
			padding: 4px 10px !important;
		}

		.data-table td,
		.data-table th {
			border: 1px solid #000;
		}

		.signature-section {
			margin-top: 15px;
		}

		.date-box {
			display: inline-block;
			width: 18px;
			height: 18px;
			border: 1px solid #000;
			text-align: center;
			line-height: 18px;
			font-size: 10pt;
		}

		@media print {
			body {
				width: 100%;
				margin: 0;
			}

			.centre-page {
				height: 330mm;
				/* Enforce height limit if needed */
			}
		}
	</style>
	<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
	<script src="../authentication.js"></script>
</head>

<body>
	<div id="centre-container"></div>

	<!-- Template -->
	<div id="centre-template" class="centre-page" style="font-family: 'NikoshBAN', 'Nikosh', sans-serif;">

		<!-- Header -->
		<div style="text-align: center; position: relative; margin-bottom: 10px;">
			<div class="sd-abs-pos" style="position: absolute; top: 0; left: 0;">
				<img src="../result/comotion_logo.png" alt="logo" width="55" height="50">
			</div>
			<div class="header-title">ফরম ১৬</div>
			<div class="header-subtitle">[বিধি ২৪(১) দ্রষ্টব্য]</div>
			<div style="font-size: 16pt; font-weight: bold;">জাতীয় সংসদ নির্বাচন ভোট গণনার বিবরণী</div>
		</div>

		<!-- Info Section -->
		<table class="info-table" style="margin-bottom: 5px;">
			<tr>
				<td class="info-label">নির্বাচনি এলাকার নম্বর ও নাম :</td>
				<td class="info-value">২৬৬ ফেনী-০২</td>
			</tr>
			<tr>
				<td class="info-label">ভোটকেন্দ্রের নম্বর ও নাম :</td>
				<td class="info-value"><span class="vote-centre-code"></span> - <span class="vote-centre-name"></span>
				</td>
			</tr>
			<tr>
				<td class="info-label">মোট ভোটার সংখ্যা :</td>
				<td class="info-value"><span class="total-voter"></span> জন</td>
			</tr>
		</table>

		<!-- Main Data Table -->
		<table class="data-table" style="margin-bottom: 10px;">
			<!-- Columns Configuration -->
			<colgroup>
				<col style="width: 5%;"> <!-- ক্রমিক -->
				<col style="width: 25%;"> <!-- প্রার্থীর নাম -->
				<col style="width: 10%;"> <!-- প্রতীক -->
				<col style="width: 12%;"> <!-- বৈধ ভোট -->
				<col style="width: 12%;"> <!-- আপত্তিকৃত -->
				<col style="width: 26%;"> <!-- মোট বৈধ -->
				<col style="width: 10%;"> <!-- মন্তব্য -->
			</colgroup>
			<thead>
				<tr style="background-color: #f8f8f8;">
					<th rowspan="2">ক্রমিক</th>
					<th rowspan="2">প্রতিদ্বন্দ্বী প্রার্থীর নাম</th>
					<th rowspan="2">প্রতিদ্বন্দ্বী প্রার্থীর প্রতীক</th>
					<th colspan="3">আপত্তিকৃত বৈধ ভোটসহ প্রাপ্ত বৈধ ভোটের সংখ্যা</th>
					<th rowspan="2">মন্তব্য</th>
				</tr>
				<tr style="background-color: #f8f8f8;">
					<th>বৈধ ভোট</th>
					<th>আপত্তিকৃত বৈধ ভোট</th>
					<th>মোট বৈধ ভোট<br><span style="font-size: 9pt; font-weight: normal;">(অংকে ও কথায়)</span></th>
				</tr>
				<tr style="font-size: 10pt;">
					<td class="text-center">১</td>
					<td class="text-center">২</td>
					<td class="text-center">৩</td>
					<td class="text-center">৪(ক)</td>
					<td class="text-center">৪(খ)</td>
					<td class="text-center">৫[৪(ক)+৪(খ)]</td>
					<td class="text-center">৬</td>
				</tr>
			</thead>
			<tbody>
				<!-- Candidate Rows will be cloned here -->
				<tr class="candidate-row" style="height: 32px;">
					<td class="text-center"><span class="candidate-serial"></span></td>
					<td style="padding-left: 5px;"><span class="candidate-name"></span></td>
					<td class="text-center"><span class="candidate-sign"></span></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<!-- Totals Row -->
				<tr style="height: 30px; background-color: #f8f8f8;">
					<td class="text-center">মোট</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>

		<!-- Summary Section (Split Tables) -->
		<div style="margin-bottom: 15px; font-size: 11pt;">
			<table class="data-table" style="width: 100%; margin-bottom: 8px;">
				<tr>
					<td style="width: 75%; border-right: none;">(১) প্রতিদ্বন্দ্বী প্রার্থীগণ কর্তৃক প্রাপ্ত ভোটের মোট
						সংখ্যা (আপত্তিকৃত ভোটসহ):</td>
					<td style="width: 25%;"></td>
				</tr>
			</table>
			<table class="data-table" style="width: 100%; margin-bottom: 8px;">
				<tr>
					<td style="width: 75%; border-right: none;">(২) গণনাকালে বাতিলকৃত (অবৈধ) ভোটের সংখ্যা:</td>
					<td style="width: 25%;"></td>
				</tr>
			</table>
			<table class="data-table" style="width: 100%;">
				<tr>
					<td style="width: 75%; border-right: none; ">(৩) মোট : [(১) ও (২) এর সমষ্টি]</td>
					<td style="width: 25%;"></td>
				</tr>
			</table>
		</div>

		<!-- Signature Section -->
		<div class="signature-section" style="margin-bottom: 10px;">
			<table style="width: 100%; border: none;">
				<tr>
					<td style="width: 60%; border: none; vertical-align: top;">
						<div style="margin-bottom: 8px; display: flex; align-items: start;">
							<span>স্থান:</span>
							<span
								style="display: inline-block; width: 450px; height: 1.3cm; border: 1px solid #000; margin-left: 8px;"></span>
						</div>
						<div style="display: flex; align-items: center;">
							তারিখ:
							<span style="width: 5px;"></span>
							<span class="date-box">১</span><span class="date-box" style="margin-left: 2px;">২</span>
							<span style="margin: 0 4px;">দিন</span>
							<span class="date-box">০</span><span class="date-box" style="margin-left: 2px;">২</span>
							<span style="margin: 0 4px;">মাস</span>
							<span class="date-box">২</span><span class="date-box"
								style="margin-left: 2px;">০</span><span class="date-box"
								style="margin-left: 2px;">২</span><span class="date-box"
								style="margin-left: 2px;">৬</span>
							<span style="margin-left: 4px;">বৎসর</span>
						</div>
					</td>
					<td style="width: 40%; border: none; text-align: center; vertical-align: top;">
						<div class="signature-box"
							style="height: 1.2in; border: 1px solid #000; width: 100%; margin: 0 auto 5px auto;"></div>
						<div style="font-size: 13pt; font-weight: bold; line-height: 1.2;">প্রিজাইডিং অফিসারের স্বাক্ষর<br>নাম ও
							পদবিসহ সিল</div>
					</td>
				</tr>
			</table>
		</div>

		<!-- Agent Table -->
		<div style="text-align: center; font-weight: bold; margin-bottom: 5px; font-size: 11pt;">
			প্রতিদ্বন্দ্বী প্রার্থী/নির্বাচনি এজেন্ট/পোলিং এজেন্টের নাম ও স্বাক্ষর
		</div>
		<table class="data-table" style="width: 100%;">
			<thead>
				<tr style="background-color: #f8f8f8;">
					<th style="width: 8%;">ক্রমিক</th>
					<th style="width: 32%;">প্রতিদ্বন্দ্বী প্রার্থী/ নির্বাচনি এজেন্ট/পোলিং এজেন্ট এর নাম</th>
					<th style="width: 20%;">জাতীয় পরিচয়পত্রের নম্বর</th>
					<th style="width: 25%;">প্রতিদ্বন্দ্বী প্রার্থী/ নির্বাচনি এজেন্ট/পোলিং এজেন্ট (যাহা প্রযোজ্য তাহা উল্লেখ করতে হইবে)</th>
					<th style="width: 15%;">স্বাক্ষর</th>
				</tr>
				<tr style="font-size: 10pt; background-color: #f8f8f8;">
					<td class="text-center">১</td>
					<td class="text-center">২</td>
					<td class="text-center">৩</td>
					<td class="text-center">৪</td>
					<td class="text-center">৫</td>
				</tr>
			</thead>
			<tbody>
				<tr style="height: 28px;">
					<td class="text-center">১</td>
					<td></td>
					<td></td>
					<td class="text-center" style="font-size: 9pt;"> </td>
					<td></td>
				</tr>
				<tr style="height: 28px;">
					<td class="text-center">২</td>
					<td></td>
					<td></td>
					<td class="text-center" style="font-size: 9pt;"></td>
					<td></td>
				</tr>
				<tr style="height: 28px;">
					<td class="text-center">৩</td>
					<td></td>
					<td></td>
					<td class="text-center" style="font-size: 9pt;"></td>
					<td></td>
				</tr>
				<tr style="height: 28px;">
					<td class="text-center">৪</td>
					<td></td>
					<td></td>
					<td class="text-center" style="font-size: 9pt;"></td>
					<td></td>
				</tr>
				<tr style="height: 28px;">
					<td class="text-center">৫</td>
					<td></td>
					<td></td>
					<td class="text-center" style="font-size: 9pt;"> </td>
					<td></td>
				</tr>
			</tbody>
		</table>

	</div>

	<script>
		(async () => {
			if (!window.supabaseClient) {
				console.error('Supabase client not initialized.');
				return;
			}

			// Helper: Convert English numbers to Bengali
			const toBengaliNumber = (n) => {
				if (n === null || n === undefined) return '';
				const numbers = {
					'0': '০', '1': '১', '2': '২', '3': '৩', '4': '৪',
					'5': '৫', '6': '৬', '7': '৭', '8': '৮', '9': '৯'
				};
				return String(n).replace(/[0-9]/g, (s) => numbers[s]);
			};

			// Fetch Centres
			const { data: centres, error: centresError } = await window.supabaseClient
				.from('vote_centre')
				.select('vote_centre_code, vote_centre_name, total_voter')
				.order('vote_centre_code', { ascending: true });

			if (centresError) console.error(centresError);

			// Fetch Candidates
			const { data: candidates, error: candidateError } = await window.supabaseClient
				.from('candidate_db')
				.select('candidate_name, candidate_sign_name, candidate_sl, candidate_iid')
				.order('candidate_sl', { ascending: true, nullsFirst: false })
				.order('candidate_iid', { ascending: true });

			if (candidateError) {
				console.error(candidateError);
				return;
			}

			const container = document.getElementById('centre-container');
			const template = document.getElementById('centre-template');
			if (!container || !template) return;

			// Function to build a page for a centre
			const buildPage = (centre) => {
				const page = template.cloneNode(true);
				page.removeAttribute('id');
				page.style.display = 'block';

				// Fill Centre Info
				page.querySelector('.vote-centre-code').textContent = toBengaliNumber(centre?.vote_centre_code);
				page.querySelector('.vote-centre-name').textContent = centre?.vote_centre_name ?? '';
				page.querySelector('.total-voter').textContent = toBengaliNumber(centre?.total_voter);

				// Handle Candidates Table
				const tbody = page.querySelector('.data-table tbody');
				const baseRow = tbody.querySelector('.candidate-row'); // Get the template row

				// Remove existing rows except totals (if any logic needed) but here strictly:
				// We keep the totals row at bottom
				const totalsRow = tbody.lastElementChild;

				// Clear rows between header/template and totals
				// Actually cleaner is to remove baseRow from DOM after cloning it for use
				baseRow.remove();

				if (Array.isArray(candidates) && candidates.length > 0) {
					candidates.forEach((candidate, index) => {
						const row = baseRow.cloneNode(true);
						row.querySelector('.candidate-serial').textContent = toBengaliNumber(index + 1);
						row.querySelector('.candidate-name').textContent = candidate.candidate_name ?? '';
						row.querySelector('.candidate-sign').textContent = candidate.candidate_sign_name ?? '';
						tbody.insertBefore(row, totalsRow);
					});

					// If we need empty rows to fill page, we can add logic here, 
					// but for now we just show list of candidates.
					// If list is small, layout is compact.
				} else {
					// Add a few empty rows if no candidates? or just 1
					for (let i = 0; i < 5; i++) {
						const row = baseRow.cloneNode(true);
						row.querySelector('.candidate-serial').textContent = toBengaliNumber(i + 1);
						tbody.insertBefore(row, totalsRow);
					}
				}

				// Logo Fix
				const logImg = page.querySelector('.sd-abs-pos img');
				if (logImg) {
					logImg.src = '../result/comotion_logo.png';
					logImg.width = 55;
					logImg.height = 50;
				}

				container.appendChild(page);
			};

			// Generate Pages
			if (Array.isArray(centres) && centres.length > 0) {
				centres.forEach(centre => buildPage(centre));
			} else {
				buildPage(null); // Preview Template
			}

			// Fix Logos globally after render just in case path issues
			document.querySelectorAll('.sd-abs-pos img').forEach(img => {
				img.src = '../result/comotion_logo.png';
			});

		})();
	</script>
</body>

</html>