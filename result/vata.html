<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ভোটগ্রহণকারী কর্মকর্তাদের ভাতা প্রদানের হিসাব বিবরণী</title>
    <style>
        @font-face {
            font-family: 'NikoshBan';
            src: local('NikoshBan');
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            font-family: 'NikoshBan', 'Nikosh', sans-serif;
            font-size: 9.5pt;
        }

        .legal-page {
            width: 8.5in;
            height: 14in;
            padding: 0.4in 0.5in;
            margin: 0 auto 20px auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
            overflow: hidden;
        }

        #loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 1000;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 5px;
        }

        th,
        td {
            border: 1px solid black;
            padding: 2px 4px;
            vertical-align: middle;
            line-height: 1.1;
        }

        .bg-gray {
            background-color: #f2f2f2 !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .fw-bold {
            font-weight: bold;
        }

        .summary-table {
            border-collapse: collapse;
            width: 100%;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid black !important;
            padding: 4px;
            font-size: 10pt;
        }

        @page {
            size: 14in 8.5in;
            margin: 0.1in;
        }

        @media print {

            body,
            html {
                margin: 0 !important;
                padding: 0 !important;
                background: none !important;
            }

            .legal-page {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0.1in !important;
                width: 13.8in !important;
                height: 8.2in !important;
                page-break-after: always !important;
                position: relative;
                overflow: visible !important;
            }

            tr {
                page-break-inside: avoid !important;
            }

            #loading-indicator {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../authentication.js"></script>
</head>

<body>
    <div id="loading-indicator">উপাত্ত লোড হচ্ছে...</div>
    <div id="app"></div>

    <script id="summary-template" type="text/template">
        <div class="legal-page summary-page" style="height: auto; min-height: 8.5in; width: 14in; height: auto;">
            <h2 class="text-center" style="margin-top: 0; margin-bottom: 5px;">ভোটগ্রহণকারী কর্মকর্তাদের ভাতা প্রদানের হিসাব বিবরণী</h2>
            <table width="100%" class="summary-table" style="font-size: 8pt;">
                <thead>
                    <tr class="bg-gray text-center fw-bold">
                        <td rowspan="2" width="3%">কেন্দ্র কোড</td>
                        <td rowspan="2" width="10%">প্রিজাইডিং অফিসারের নাম</td>
                        <td rowspan="2" width="15%">ভোটকেন্দ্রের নাম</td>
                        <td rowspan="2" width="2%">কক্ষ</td>
                        <td width="5%">প্রিজাইডিং (৮০০০x১ হারে)</td>
                        <td width="5%">সহকারী প্রিজাইডিং (৬০০০*বুথ)</td>
                        <td width="5%">পোলিং (৪০০০*২*বুথ)</td>
                        <td width="5%">যাতায়াত (১০০০*জন)</td>
                        <td width="5%">বেষ্টনী (১২০০)</td>
                        <td width="5%">মনিহারি (১৫০০)</td>
                        <td rowspan="2" width="7%">মোট টাকার পরিমাণ</td>
                        <td colspan="4" width="12%">কর্তন</td>
                        <td rowspan="2" width="5%">মোট কর্তন</td>
                        <td rowspan="2" width="7%">মোট প্রদত্ত টাকা</td>
                        <td rowspan="2" width="8%">স্বাক্ষর</td>
                    </tr>
                    <tr class="bg-gray text-center fw-bold" style="font-size: 7pt;">
                        <td>১</td>
                        <td>২</td>
                        <td>৩</td>
                        <td>৪</td>
                        <td>৫</td>
                        <td>৬</td>
                        <td>উৎসে কর ১০% (১,২,৩)</td>
                        <td>বেষ্টনী ভ্যাট ৫% + আয়কর ১০% (১৫%)</td>
                        <td>মনিহারি (ভ্যাট ১০%, আয়কর ৫%) ১৫%</td>
                        <td>রেভিনিউ</td>
                    </tr>
                </thead>
                <tbody>
                    {{rows}}
                </tbody>
                <tbody>
                    <tr class="fw-bold bg-gray text-center">
                        <td colspan="4" class="text-right">সর্বমোট:</td>
                        <td>{{total_prv}}</td>
                        <td>{{total_asst}}</td>
                        <td>{{total_pol}}</td>
                        <td>{{total_travel}}</td>
                        <td>{{total_bestni}}</td>
                        <td>{{total_monihari}}</td>
                        <td>{{total_gross}}</td>
                        <td>{{total_tax}}</td>
                        <td>{{total_vat}}</td>
                        <td>{{total_monihari_vat}}</td>
                        <td>{{total_rev}}</td>
                        <td>{{total_deduction}}</td>
                        <td>{{total_net}}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <table width="100%" class="signature-table" style="margin-top: 20px; border: none;">
                <tr valign="top" class="text-center" style="border: none;">
                    <td width="33%" style="border: none;">
                        <p style="border-top: 1px solid black; display: inline-block; width: 180px; padding-top: 5px;"><b>অফিস সহকারী/আইটি</b></p>
                    </td>
                    <td width="33%" style="border: none;">
                         <p style="border-top: 1px solid black; display: inline-block; width: 220px; padding-top: 5px;"><b>হিসাব রক্ষণ কর্মকর্তা</b></p>
                    </td>
                    <td width="33%" style="border: none;">
                        <p style="border-top: 1px solid black; display: inline-block; width: 220px; padding-top: 5px;"><b>রিটার্নিং/সহকারী রিটার্নিং অফিসার</b></p>
                    </td>
                </tr>
            </table>
        </div>
    </script>

    <script>
        const App = {
            bn: ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'],

            toBn(n) { return n === null ? '' : String(n).replace(/\d/g, d => this.bn[+d]); },
            toEn(s) { const m = { '০': '0', '১': '1', '২': '2', '৩': '3', '৪': '4', '৫': '5', '৬': '6', '৭': '7', '৮': '8', '৯': '9' }; return String(s).replace(/[০-৯]/g, x => m[x]); },

            async init() {
                try {
                    // Fetch centers and assignments separately
                    const [centersRes, assignmentsRes] = await Promise.all([
                        window.supabaseClient.from('vote_centre').select('*').limit(5000),
                        window.supabaseClient.from('centre_assignments').select('vote_centre_code, officer_name, officer_type').eq('officer_type', 'presiding').limit(5000)
                    ]);

                    if (centersRes.error) throw centersRes.error;
                    if (assignmentsRes.error) throw assignmentsRes.error;

                    const data = centersRes.data.sort((a, b) => (Number(a.vote_centre_code) || 0) - (Number(b.vote_centre_code) || 0));
                    const assignments = assignmentsRes.data;

                    const container = document.getElementById('app');
                    let rowsHtml = '';
                    let sumPrv = 0, sumAsst = 0, sumPol = 0, sumTravel = 0, sumBestni = 0, sumMonihari = 0;
                    let sumGross = 0, sumTax = 0, sumVat = 0, sumMonihariVat = 0, sumRev = 0, sumDeduction = 0, sumNet = 0;

                    data.forEach((d) => {
                        const res = this.calculate(d);
                        // Manual join: Find presiding officer for this centre code
                        const presidingName = assignments.find(a => String(a.vote_centre_code) === String(d.vote_centre_code))?.officer_name || '';

                        sumPrv += 8000;
                        sumAsst += res.assistantTotal;
                        sumPol += res.pollingTotal;
                        sumTravel += res.travelTotal;
                        sumBestni += res.bestniTotal;
                        sumMonihari += res.monihariTotal;
                        sumGross += res.gross;
                        sumTax += res.tax10;
                        sumVat += res.vatIt;
                        sumMonihariVat += res.monihariVat;
                        sumRev += res.revenue;
                        sumDeduction += res.deduction;
                        sumNet += res.net;

                        rowsHtml += `
                            <tr class="text-center">
                                <td>${this.toBn(d.vote_centre_code)}</td>
                                <td class="text-left">${presidingName}</td>
                                <td class="text-left">${d.vote_centre_name}</td>
                                <td>${this.toBn(res.vbt)}</td>
                                <td>${this.toBn((8000).toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.assistantTotal.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.pollingTotal.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.travelTotal.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.bestniTotal.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.monihariTotal.toLocaleString('bn-BD'))}</td>
                                <td class="fw-bold">${this.toBn(res.gross.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.tax10.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.vatIt.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.monihariVat.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.revenue.toLocaleString('bn-BD'))}</td>
                                <td>${this.toBn(res.deduction.toLocaleString('bn-BD'))}</td>
                                <td class="fw-bold">${this.toBn(res.net.toLocaleString('bn-BD'))}</td>
                                <td></td>
                            </tr>
                        `;
                    });

                    let sTmp = document.getElementById('summary-template').innerHTML;
                    sTmp = sTmp.replace('{{rows}}', rowsHtml)
                        .replace('{{total_prv}}', this.toBn(sumPrv.toLocaleString('bn-BD')))
                        .replace('{{total_asst}}', this.toBn(sumAsst.toLocaleString('bn-BD')))
                        .replace('{{total_pol}}', this.toBn(sumPol.toLocaleString('bn-BD')))
                        .replace('{{total_travel}}', this.toBn(sumTravel.toLocaleString('bn-BD')))
                        .replace('{{total_bestni}}', this.toBn(sumBestni.toLocaleString('bn-BD')))
                        .replace('{{total_monihari}}', this.toBn(sumMonihari.toLocaleString('bn-BD')))
                        .replace('{{total_gross}}', this.toBn(sumGross.toLocaleString('bn-BD')))
                        .replace('{{total_tax}}', this.toBn(sumTax.toLocaleString('bn-BD')))
                        .replace('{{total_vat}}', this.toBn(sumVat.toLocaleString('bn-BD')))
                        .replace('{{total_monihari_vat}}', this.toBn(sumMonihariVat.toLocaleString('bn-BD')))
                        .replace('{{total_rev}}', this.toBn(sumRev.toLocaleString('bn-BD')))
                        .replace('{{total_deduction}}', this.toBn(sumDeduction.toLocaleString('bn-BD')))
                        .replace('{{total_net}}', this.toBn(sumNet.toLocaleString('bn-BD')));

                    const sEl = document.createElement('div');
                    sEl.innerHTML = sTmp;
                    container.appendChild(sEl.firstElementChild);

                    document.getElementById('loading-indicator').style.display = 'none';
                } catch (e) {
                    console.error(e);
                    document.getElementById('loading-indicator').textContent = "ত্রুটি ঘটেছে!";
                }
            },

            calculate(data) {
                const totalVoter = parseInt(this.toEn(data.total_voter || 0));
                const voterBothTotal = parseInt(this.toEn(data.voter_both_total)) || Math.ceil(totalVoter / 1200);
                const totalOfficer = 1 + voterBothTotal + (voterBothTotal * 2);

                const presidingTotal = 8000;
                const assistantTotal = voterBothTotal * 6000;
                const pollingTotal = (voterBothTotal * 2) * 4000;
                const honorariumTotal = presidingTotal + assistantTotal + pollingTotal;

                const travelTotal = totalOfficer * 1000;
                const bestniTotal = voterBothTotal * 1200;
                const monihariTotal = 1500;

                const grossTotal = honorariumTotal + travelTotal + bestniTotal + monihariTotal;
                const tax10 = Math.round(honorariumTotal * 0.10);
                const vatIt = Math.round(bestniTotal * 0.15);
                const monihariVat = Math.round(monihariTotal * 0.15);
                const revenue = (totalOfficer + 2) * 10;

                const totalDeduction = tax10 + vatIt + monihariVat + revenue;
                const netTotal = grossTotal - totalDeduction;

                return {
                    gross: grossTotal,
                    deduction: totalDeduction,
                    net: netTotal,
                    vbt: voterBothTotal,
                    voter: totalVoter,
                    officer: totalOfficer,
                    assistantTotal,
                    pollingTotal,
                    travelTotal,
                    bestniTotal,
                    monihariTotal,
                    tax10,
                    vatIt,
                    monihariVat,
                    revenue
                };
            }
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>